@*
 * Copyright 2025 HM Revenue & Customs
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *@

@import _root_.implicits.ImplicitDateFormatterImpl
@import _root_.implicits.ImplicitCurrencyFormatter._
@import models.financialDetails._
@import models.financialDetails.YourSelfAssessmentChargesViewModel.getDisplayDueDate
@import auth.MtdItUser
@import views.html.layouts.unifiedLayout
@import views.html.components._
@import uk.gov.hmrc.govukfrontend.views.html.components._
@import models.financialDetails.Nics2
@import models.financialDetails.MfaDebitCharge
@import services.DateServiceInterface
@import _root_.implicits.HtmlFormatter.NbspString
@import views.html.partials.yourSelfAssessmentCharges._

@this(
    mainTemplate: unifiedLayout,
    implicitDateFormatter: ImplicitDateFormatterImpl,
    appConfig: config.FrontendAppConfig,
    h1: h1,
    h2: h2,
    h3: h3,
    p: p,
    link: link,
    detailsDropdown: detailsDropdown,
    govukWarningText: GovukWarningText,
    govukInsetText: GovukInsetText,
    dunningLockParagraph: DunningLockParagraph,
    paymentPlanSection: PaymentPlanSection,
    claimToAdjustPoaSection: ClaimToAdjustPoaSection,
    taxYearSummaryLink: TaxYearSummaryLink,
    codingOutInsetContent: CodingOutInsetContent,
    paymentTypeEntry: PaymentTypeEntry,
    availableCreditInAccount: AvailableCreditInAccount,
    unallocatedCreditParagraphContent: UnallocatedCreditParagraphContent,
    chargesDueNotificationBanner: ChargesDueNotificationBanner,
    saNoteParagraph: SaNoteParagraph
)

@(
    viewModel: YourSelfAssessmentChargesViewModel,
    origin: Option[String] = None
)(
    implicit request: Request[_],
    user: MtdItUser[_],
    messages: Messages,
    dateService: DateServiceInterface
)

    @import implicitDateFormatter.longDate

    @btaNavPartial = @{
        user.btaNavPartial
    }

    @getMessage(key: String, args: String*) = @{
        messages(s"selfAssessmentCharges.$key", args: _*)
    }

    @getPrefix(key: String) = @{
        s"whatYouOwe.$key"
    }

    @tableHead(headId: String, showInterest: Boolean) = {
        <thead class="govuk-table__head" id="@headId">
            <tr class="govuk-table__row">
                <th scope="col" class="govuk-table__header">@getMessage("tableHead.due-date")</th>
                <th scope="col" class="govuk-table__header">@getMessage("tableHead.type-of-charge")</th>
                <th scope="col" class="govuk-table__header govuk-table__header--numeric">@getMessage("tableHead.tax-year")</th>
                @if(showInterest) {
                <th scope="col" class="govuk-table__header govuk-table__header--numeric">
                    @getMessage("tableHead.estimated-interest")
                </th>
                }
                <th scope="col" class="govuk-table__header govuk-table__header--numeric">@getMessage("tableHead.amount").toNonBreaking</th>
            </tr>
        </thead>
    }

    @tableRowWithInterest(rowId: String, chargeItem: ChargeItem, index: Int, id: String) = {
        <tr class="govuk-table__row" id="@rowId">
            <td class="govuk-table__cell">
                @getDisplayDueDate(chargeItem).toLongDateShort.toNonBreaking
            </td>
            <td class="govuk-table__cell">
                @paymentTypeEntry(viewModel.LPP2Url, chargeItem, rowId, isOverduePayment = true, index, origin)

                @if(chargeItem.dunningLock) {
                    <div class="form-hint govuk-body-s"> @getMessage("paymentUnderReview") </div>
                }
                @if(chargeItem.hasLpiWithDunningLock) {
                    <div class="form-hint govuk-body-s" id="LpiDunningLock"> @getMessage("paymentUnderReview") </div>
                }
            </td>
            <td class="govuk-table__cell"> @taxYearSummaryLink(chargeItem.taxYear.endYear, index, id, viewModel.taxYearSummaryUrl(chargeItem.taxYear.endYear, origin))</td>
            <td class="govuk-table__cell govuk-table__cell--numeric"> @if(chargeItem.hasAccruingInterest) @{
                chargeItem.getInterestOutstandingAmount.toCurrency
            }</td>
            <td class="govuk-table__cell govuk-table__cell--numeric">@{
                if(chargeItem.isOnlyInterest) {
                    chargeItem.interestRemainingToPay.toCurrency
                } else {
                    chargeItem.remainingToPay.toCurrency
                }
            }</td>
        </tr>
    }

    @tableRowWithoutInterest(rowId: String, chargeItem: ChargeItem, index: Int, id: String) = {
    <tr class="govuk-table__row" id="@rowId">
        <td class="govuk-table__cell">
            @getDisplayDueDate(chargeItem).toLongDateShort.toNonBreaking
        </td>
        <td class="govuk-table__cell">
            @paymentTypeEntry(viewModel.LPP2Url, chargeItem, rowId, isOverduePayment = false, index, origin)
        </td>
        <td class="govuk-table__cell govuk-table__cell--numeric">
            @taxYearSummaryLink(chargeItem.taxYear.endYear, index, id, viewModel.taxYearSummaryUrl(chargeItem.taxYear.endYear, origin))
        </td>
        <td class="govuk-table__cell govuk-table__cell--numeric">
            @chargeItem.remainingToPay.toCurrency
        </td>
    </tr>
    }

    @getNoPaymentsDueText = @{
        if(user.isAgent()) messages("whatYouOwe.no-payments-due-agent") else messages("whatYouOwe.no-payments-due")
    }

    @mainTemplate(
        pageTitle = getMessage("heading"),
        backUrl = Some(viewModel.backUrl),
        isAgent = user.isAgent(),
        btaNavPartial = btaNavPartial,
        useFallbackBackLink = true,
        mainClass = Some("govuk-width-container")
    ) {
        <div class="govuk-grid-row">
            <div class="govuk-grid-column-three-quarters">

                @h1(msg = getMessage("heading"), id = Some("page-heading"))

                @if(viewModel.whatYouOweChargesList.isChargesListEmpty && viewModel.whatYouOweChargesList.codedOutDetails.isEmpty) {

                    @p(id = Some("no-payments-due"))(Html(getNoPaymentsDueText))

                    @claimToAdjustPoaSection(
                        viewModel.whatYouOweChargesList.hasUnpaidPOAs,
                        viewModel.claimToAdjustViewModel.claimToAdjustTaxYear
                    )

                    @saNoteParagraph()

                } else {
                    <div>
                        @if(viewModel.whatYouOweChargesList.chargesList.nonEmpty || viewModel.whatYouOweChargesList.bcdChargeTypeDefinedAndGreaterThanZero) {

                            @if(ChargeItem.overdueOrAccruingInterestChargeList(viewModel.whatYouOweChargesList) || viewModel.whatYouOweChargesList.overdueOutstandingCharges.nonEmpty) {

                                @chargesDueNotificationBanner(
                                    viewModel.whatYouOweChargesList.balanceDetails.overDueAmount.toCurrencyString,
                                    viewModel.whatYouOweChargesList.getEarliestTaxYearAndAmountByDueDate.get._2.toPence,
                                    origin
                                )

                            } else {
                        @h2(msg = "selfAssessmentCharges.no-charges-due")
                        <p class="govuk-body">
                            @getMessage("adjust-poa.paid-1")
                            @viewModel.whatYouOweChargesList.getEarliestTaxYearAndAmountByDueDate.fold(Html("")) { case (_, amount) =>
                            @link(
                            link = controllers.routes.PaymentController.paymentHandoff(amount.toPence, origin).url,
                            messageKey = getMessage("pay-upcoming-charges"),
                            id = Some("pay-upcoming-charges-link")
                            )
                            }
                        </p>
                        <br>
                        }

                        <div class="govuk-tabs" data-module="govuk-tabs" id="self-assessment-charges-tabs">
                            <h2 class="govuk-tabs__title">
                                Contents
                            </h2>
                            <ul class="govuk-tabs__list">
                                @if(viewModel.overdueAccruingInterestOrOutstandingChargesListNonEmpty) {
                                    <li class="govuk-tabs__list-item govuk-tabs__list-item--selected">
                                        <a class="govuk-tabs__tab" href="#charges-due-now">
                                        @getMessage("charges-due-now")
                                        </a>
                                    </li>
                                }
                                @if(viewModel.chargesDueWithin30DaysListNonEmpty) {
                                <li class="govuk-tabs__list-item">
                                    <a class="govuk-tabs__tab" href="#charges-due-in-30-days">
                                        @getMessage("charges-due-in-30-days")
                                    </a>
                                </li>
                                }
                                @if(viewModel.chargesDueAfter30DaysListNonEmpty) {
                                    <li class="govuk-tabs__list-item">
                                        <a class="govuk-tabs__tab" href="#charges-due-later">
                                        @getMessage("charges-to-pay-later")
                                        </a>
                                    </li>
                                }
                            </ul>

                            @if(viewModel.overdueAccruingInterestOrOutstandingChargesListNonEmpty) {
                                <div class="govuk-tabs__panel" id="charges-due-now">
                                    <table class="govuk-table" id="charges-due-now-table">
                                        @tableHead("over-due-payments-table-head", true)
                                        <caption class="govuk-table__caption govuk-visually-hidden">@getMessage("charges-due-now")</caption>
                                        <tbody class="govuk-table__body">
                                            @if(viewModel.whatYouOweChargesList.bcdChargeTypeDefinedAndGreaterThanZero) {
                                                <tr class="govuk-table__row" id="balancing-charge-type-0">
                                                    <td class="govuk-table__cell">@{
                                                        viewModel.whatYouOweChargesList.getRelevantDueDate.toLongDateShort
                                                    }</td>
                                                    <td class="govuk-table__cell">
                                                        @p(id = Some("balancing-charge"))(Html(getMessage("balancingCharge.text")))
                                                        @p(id = Some("pre-mtd-digital"))(Html(getMessage("pre-mtd-digital")))
                                                    </td>
                                                    <td class="govuk-table__cell">
                                                    @getMessage("pre-mtd-year", (viewModel.currentTaxYear.endYear - 2).toString, (viewModel.currentTaxYear.endYear - 1).toString)
                                                    </td>
                                                    <td class="govuk-table__cell govuk-table__cell--numeric">
                                                    @if(viewModel.whatYouOweChargesList.outstandingChargesModel.get.getAciChargeWithTieBreaker.isDefined
                                                            && viewModel.whatYouOweChargesList.getRelevantDueDate.isBefore(viewModel.currentDate)) @{
                                                        viewModel.whatYouOweChargesList.getAciChargeWithTieBreakerChargeAmount.toCurrency
                                                    }
                                                    </td>
                                                    <td class="govuk-table__cell govuk-table__cell--numeric">@{
                                                        viewModel.whatYouOweChargesList.outstandingChargesModel.get.bcdChargeType.get.chargeAmount.toCurrency
                                                    }</td>
                                                </tr>
                                            }
                                            @for((charge, index) <- viewModel.overdueChargesWithIndex) {
                                                @tableRowWithInterest(s"due-$index", charge, index, "taxYearSummary-link")
                                            }
                                            <tr class="govuk-table__header">
                                                <td class="govuk-table__header" colspan="2" id="total-amount">
                                                @getMessage("table.total-amount", viewModel.whatYouOweChargesList.balanceDetails.overDueAmount.toCurrencyString)
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>

                                    <div class="govuk-inset-text" id="overdue-payment-text">
                                        <div>
                                        @getMessage("overdue-inset-text-1")
                                        </div>
                                        <br>
                                        <div>
                                        @getMessage("overdue-inset-text-2")
                                        </div>
                                    </div>

                                    @if(user.saUtr.isDefined && !user.isAgent()) {
                                        @viewModel.earliestTaxYearAndAmountByDueDate.map { taxYearWithAmount =>
                                            <div id="payment-button">
                                                @link(
                                                    controllers.routes.PaymentController.paymentHandoff(taxYearWithAmount.amount.toPence, origin).url,
                                                    messageKey = getPrefix("payNow"),
                                                    classes = "govuk-button",
                                                    role = Some("button"),
                                                    id = Some("payment-button-link")
                                                    )
                                            </div>
                                        }
                                    }
                                </div>
                            }

                            @if(viewModel.chargesDueWithin30DaysListNonEmpty) {
                                <div class="govuk-tabs__panel" id="charges-due-in-30-days">
                                    <table class="govuk-table">
                                        @tableHead("due-in-30-days-payments-table-head", false)
                                        <tbody class="govuk-table__body">
                                            @for((charge, index) <- viewModel.chargesDueWithin30DaysWithIndex) {
                                                @tableRowWithoutInterest(s"due-30-days-$index", charge, index, "taxYearSummary-link")
                                            }
                                            <tr class="govuk-table__header">
                                                <td class="govuk-table__header" colspan="2">
                                                @getMessage("table.total-amount", viewModel.whatYouOweChargesList.balanceDetails.balanceDueWithin30Days.toCurrencyString)
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>

                                    @if(user.saUtr.isDefined && !user.isAgent() && !viewModel.overdueAccruingInterestOrOutstandingChargesListNonEmpty) {
                                        <div class="govuk-inset-text" id="30-days-payment-text">
                                            <div>
                                            @getMessage("overdue-inset-text-1")
                                            </div>
                                            <br>
                                            <div>
                                            @getMessage("overdue-inset-text-2")
                                            </div>
                                        </div>

                                        @viewModel.earliestTaxYearAndAmountByDueDate.map { taxYearWithAmount =>
                                            <div id="payment-button">
                                                @link(
                                                    controllers.routes.PaymentController.paymentHandoff(taxYearWithAmount.amount.toPence, origin).url,
                                                    messageKey = getPrefix("payNow"),
                                                    classes = "govuk-button",
                                                    role = Some("button"),
                                                    id = Some("payment-button-link")
                                                )
                                            </div>
                                        }
                                    }
                                </div>
                            }

                            @if(viewModel.chargesDueAfter30DaysListNonEmpty) {
                                <div class="govuk-tabs__panel" id="charges-due-later">
                                    <table class="govuk-table">
                                        @tableHead("charges-due-later-table-head", showInterest = false)
                                        <tbody class="govuk-table__body">
                                        @for((charge, index) <- viewModel.chargesDueAfter30DaysWithIndex) {
                                            @tableRowWithoutInterest(s"due-$index", charge, index, "taxYearSummary-link")
                                        }
                                        </tbody>
                                    </table>

                                    @if(user.saUtr.isDefined && !user.isAgent() && !viewModel.overdueAccruingInterestOrOutstandingChargesListNonEmpty && !viewModel.chargesDueWithin30DaysListNonEmpty) {
                                        <div class="govuk-inset-text" id="later-payment-text">
                                            <div>
                                            @getMessage("overdue-inset-text-1")
                                            </div>
                                            <br>
                                            <div>
                                            @getMessage("overdue-inset-text-2")
                                            </div>
                                        </div>
                                        @viewModel.earliestTaxYearAndAmountByDueDate.map { taxYearWithAmount =>
                                            <div id="payment-button">
                                                @link(
                                                    controllers.routes.PaymentController.paymentHandoff(taxYearWithAmount.amount.toPence, origin).url,
                                                    messageKey = getPrefix("payNow"),
                                                    classes = "govuk-button",
                                                    role = Some("button"),
                                                    id = Some("payment-button-link")
                                                )
                                            </div>
                                        }
                                    }
                                </div>
                            }
                            </div>

                            @paymentPlanSection(viewModel.selfServeTimeToPayStartUrl)
                        }

                        @if(!viewModel.whatYouOweChargesList.isChargesListEmpty && viewModel.dunningLock && viewModel.hasLpiWithDunningLock) {
                            @dunningLockParagraph()
                        }

                        @claimToAdjustPoaSection(
                            viewModel.whatYouOweChargesList.hasUnpaidPOAs,
                            viewModel.claimToAdjustViewModel.claimToAdjustTaxYear
                        )

                        @viewModel.whatYouOweChargesList.codedOutDetails.map { codingOutDetails =>
                            <div id="coding-out-wrapper">
                                @govukInsetText(InsetText(
                                    content = HtmlContent(
                                        codingOutInsetContent(codingOutDetails, origin)
                                    )))
                            </div>
                        }
                        @if(viewModel.whatYouOweChargesList.isChargesListEmpty) {
                            @saNoteParagraph()
                        }

                    </div>
                    @if(!viewModel.whatYouOweChargesList.isChargesListEmpty) {
                        @saNoteParagraph()
                    }
                    @viewModel.whatYouOweChargesList.availableCredit.map { availableCreditAmt =>
                        @unallocatedCreditParagraphContent(
                            availableCreditAmt.toCurrencyString,
                            viewModel.creditAndRefundUrl
                        )
                    }

                }

                @if(viewModel.creditAndRefundEnabled) {
                    @viewModel.whatYouOweChargesList.availableCredit.map { ac =>
                        @availableCreditInAccount(
                            ac.toCurrencyString,
                            viewModel.creditAndRefundsControllerUrl
                        )
                    }
                }
            </div>
        </div>
    }
