@*
 * Copyright 2025 HM Revenue & Customs
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *@

@import _root_.implicits.ImplicitDateFormatterImpl
@import _root_.implicits.ImplicitCurrencyFormatter._
@import models.financialDetails._
@import models.financialDetails.YourSelfAssessmentChargesViewModel.getDisplayDueDate
@import auth.MtdItUser
@import views.html.layouts.unifiedLayout
@import views.html.components._
@import uk.gov.hmrc.govukfrontend.views.html.components._
@import services.DateServiceInterface
@import _root_.implicits.HtmlFormatter.NbspString
@import views.html.partials.yourSelfAssessmentCharges.SaNoteParagraph
@import views.html.partials.yourSelfAssessmentCharges.UnallocatedCreditParagraphContent
@import views.html.partials.yourSelfAssessmentCharges.DunningLockParagraph
@import views.html.partials.yourSelfAssessmentCharges.CodingOutInsetContent
@import views.html.partials.yourSelfAssessmentCharges.AvailableCreditInAccount
@import views.html.partials.yourSelfAssessmentCharges.GetPaymentPlanSection
@import views.html.partials.yourSelfAssessmentCharges.ClaimToAdjustPoaSection
@import views.html.partials.yourSelfAssessmentCharges.TaxYearSummaryLink
@import views.html.partials.yourSelfAssessmentCharges.GetPaymentTypeEntry
@import views.html.partials.yourSelfAssessmentCharges.GovukNotificationBannerHtml
@import views.html.partials.yourSelfAssessmentCharges.NoChargesDueContent
@import views.html.partials.yourSelfAssessmentCharges.PaymentButton

@this(
    mainTemplate: unifiedLayout,
    implicitDateFormatter: ImplicitDateFormatterImpl,
    appConfig: config.FrontendAppConfig,
    h1: h1,
    h2: h2,
    h3: h3,
    p: p,
    link: link,
    govukTabs : GovukTabs,
    govukTable : GovukTable,
    detailsDropdown: detailsDropdown,
    govukWarningText: GovukWarningText,
    govukNotificationBanner: GovukNotificationBanner,
    saNoteParagraph: SaNoteParagraph,
    dunningLockParagraph: DunningLockParagraph,
    codingOutInsetContent: CodingOutInsetContent,
    getPaymentPlanSection: GetPaymentPlanSection,
    availableCreditInAccount: AvailableCreditInAccount,
    claimToAdjustPoaSection: ClaimToAdjustPoaSection,
    taxYearSummaryLink: TaxYearSummaryLink,
    getPaymentTypeEntry: GetPaymentTypeEntry,
    paymentButton: PaymentButton,
    noChargesDueContent: NoChargesDueContent,
    govukNotificationBannerHtml: GovukNotificationBannerHtml,
    unallocatedCreditParagraphContent: UnallocatedCreditParagraphContent,
    govukInsetText: GovukInsetText
)

@(
    viewModel: YourSelfAssessmentChargesViewModel,
    origin: Option[String] = None
)(
    implicit request: Request[_],
    user: MtdItUser[_],
    messages: Messages,
    dateService: DateServiceInterface
)

@import implicitDateFormatter.longDate


@getMessage(key: String, args: String*) = @{
    messages(s"selfAssessmentCharges.$key", args: _*)
}

@getPrefix(key: String) = @{
    s"whatYouOwe.$key"
}

@paymentHandoffUrl = @{ controllers.routes.PaymentController.paymentHandoff(viewModel.whatYouOweChargesList.getEarliestTaxYearAndAmountByDueDate.get._2.toPence, origin).url }

@html = {
    <div class="govuk-tabs__panel" id="charges-due-now">
        <table class="govuk-table" id="charges-due-now-table">
            @tableHead("over-due-payments-table-head", true)
            <caption class="govuk-table__caption govuk-visually-hidden">@getMessage("charges-due-now")</caption>
            <tbody class="govuk-table__body">
                @if(viewModel.whatYouOweChargesList.bcdChargeTypeDefinedAndGreaterThanZero) {
                    <tr class="govuk-table__row" id="balancing-charge-type-0">
                        <td class="govuk-table__cell">@{
                            viewModel.whatYouOweChargesList.getRelevantDueDate.toLongDateShort
                        }</td>
                        <td class="govuk-table__cell">
                            @p(id = Some("balancing-charge"))(Html(getMessage("balancingCharge.text")))
                            @p(id = Some("pre-mtd-digital"))(Html(getMessage("pre-mtd-digital")))
                        </td>
                        <td class="govuk-table__cell">
                        @getMessage("pre-mtd-year", (viewModel.currentTaxYear.endYear - 2).toString, (viewModel.currentTaxYear.endYear - 1).toString)
                        </td>
                        <td class="govuk-table__cell govuk-table__cell--numeric">
                        @if(viewModel.whatYouOweChargesList.outstandingChargesModel.get.getAciChargeWithTieBreaker.isDefined
                                && viewModel.whatYouOweChargesList.getRelevantDueDate.isBefore(viewModel.currentDate)) @{
                            viewModel.whatYouOweChargesList.getAciChargeWithTieBreakerChargeAmount.toCurrency
                        }
                        </td>
                        <td class="govuk-table__cell govuk-table__cell--numeric">@{
                            viewModel.whatYouOweChargesList.outstandingChargesModel.get.bcdChargeType.get.chargeAmount.toCurrency
                        }</td>
                    </tr>
                }
                @for((charge, index) <- viewModel.overdueChargesWithIndex) {
                    @tableRowWithInterest(s"due-$index", charge, index, "taxYearSummary-link")
                }
                <tr class="govuk-table__header">
                    <td class="govuk-table__header" colspan="2" id="total-amount">
                    @getMessage("table.total-amount", viewModel.whatYouOweChargesList.balanceDetails.overDueAmount.toCurrencyString)
                    </td>
                </tr>
            </tbody>
        </table>

        <div class="govuk-inset-text" id="overdue-payment-text">
            <div>
            @getMessage("overdue-inset-text-1")
            </div>
            <br>
            <div>
            @getMessage("overdue-inset-text-2")
            </div>
        </div>

        @if(user.saUtr.isDefined && !user.isAgent()) {
            @paymentButton(viewModel.earliestTaxYearAndAmountByDueDate)
        }
    </div>
}

@tableHead(headId: String, showInterest: Boolean) = {

    <thead class="govuk-table__head" id="@headId">
        <tr class="govuk-table__row">
            <th scope="col" class="govuk-table__header">@getMessage("tableHead.due-date")</th>
            <th scope="col" class="govuk-table__header">@getMessage("tableHead.type-of-charge")</th>
            <th scope="col" class="govuk-table__header govuk-table__header--numeric">@getMessage("tableHead.tax-year")</th>
            @if(showInterest) {
            <th scope="col" class="govuk-table__header govuk-table__header--numeric">
                @getMessage("tableHead.estimated-interest")
            </th>
            }
            <th scope="col" class="govuk-table__header govuk-table__header--numeric">@getMessage("tableHead.amount").toNbsp</th>
        </tr>
    </thead>
}

    @tableRowWithInterest(rowId: String, chargeItem: ChargeItem, index: Int, id: String) = {
        <tr class="govuk-table__row" id="@rowId">
            <td class="govuk-table__cell">
                @getDisplayDueDate(chargeItem).toLongDateShort.toNbsp
            </td>
            <td class="govuk-table__cell">
                @getPaymentTypeEntry(chargeItem = chargeItem, isOverduePayment = true,
                    rowId = rowId, index = index)

                @if(chargeItem.dunningLock) {
                    <div class="form-hint govuk-body-s"> @getMessage("paymentUnderReview") </div>
                }
                @if(chargeItem.hasLpiWithDunningLock) {
                    <div class="form-hint govuk-body-s" id="LpiDunningLock"> @getMessage("paymentUnderReview") </div>
                }
            </td>
            <td class="govuk-table__cell"> @taxYearSummaryLink(chargeItem.taxYear.endYear, index, id)</td>
            <td class="govuk-table__cell govuk-table__cell--numeric"> @if(chargeItem.hasAccruingInterest) @{
                chargeItem.getInterestOutstandingAmount.toCurrency
            }</td>
            <td class="govuk-table__cell govuk-table__cell--numeric">@{
                if(chargeItem.isOnlyInterest) {
                    chargeItem.interestRemainingToPay.toCurrency
                } else {
                    chargeItem.remainingToPay.toCurrency
                }
            }</td>
        </tr>
    }

    @tableRowWithoutInterest(rowId: String, chargeItem: ChargeItem, index: Int, id: String) = {
    <tr class="govuk-table__row" id="@rowId">
        <td class="govuk-table__cell">
            @getDisplayDueDate(chargeItem).toLongDateShort.toNbsp
        </td>
        <td class="govuk-table__cell">
            @getPaymentTypeEntry(chargeItem = chargeItem, isOverduePayment = false,
            rowId = rowId, index = index)
        </td>
        <td class="govuk-table__cell govuk-table__cell--numeric">
            @taxYearSummaryLink(chargeItem.taxYear.endYear, index, id)
        </td>
        <td class="govuk-table__cell govuk-table__cell--numeric">
            @chargeItem.remainingToPay.toCurrency
        </td>
    </tr>
    }

    @mainTemplate(
        pageTitle = getMessage("heading"),
        backUrl = Some(viewModel.backUrl),
        isAgent = user.isAgent(),
        btaNavPartial = user.btaNavPartial,
        mainClass = Some("govuk-width-container")
    ) {

    @govukTabs(Tabs(
        items = Seq(
            Some(TabItem(
                id = Some("charges-due-now"),
                label = getMessage("charges-due-now"),
                panel = TabPanel(
                    content = HtmlContent(html)
                )
            )),
            Option.when(!viewModel.overdueAccruingInterestOrOutstandingChargesListNonEmpty)(
                TabItem(
                    id = Some("charges-due-now"),
                    label = getMessage("charges-due-now"),
                    panel = TabPanel(
                        content = HtmlContent(html)
                    )
                )
            )
        ).flatten
    ))


























        <div class="govuk-grid-row">
            <div class="govuk-grid-column-three-quarters">

                @h1(msg = getMessage("heading"), id = Some("page-heading"))

                @if(viewModel.whatYouOweChargesList.isChargesListEmpty && viewModel.whatYouOweChargesList.codedOutDocumentDetail.isEmpty) {

                    @p(id = Some("no-payments-due"))(Html({
                        if(user.isAgent()) messages("whatYouOwe.no-payments-due-agent")
                        else               messages("whatYouOwe.no-payments-due")
                    }))

                    @claimToAdjustPoaSection(viewModel)

                    @saNoteParagraph()
                } else {
                    <div>

                        @if(viewModel.whatYouOweChargesList.chargesList.nonEmpty || viewModel.whatYouOweChargesList.bcdChargeTypeDefinedAndGreaterThanZero) {
                            @if(ChargeItem.overdueOrAccruingInterestChargeList(viewModel.whatYouOweChargesList) || viewModel.whatYouOweChargesList.overdueOutstandingCharges.nonEmpty) {
                                @govukNotificationBanner(NotificationBanner(
                                    content = HtmlContent(govukNotificationBannerHtml(
                                        viewModel.whatYouOweChargesList.balanceDetails.overDueAmount,
                                        paymentHandoffUrl
                                    )),
                                    titleId = Some("overdue-banner")
                                ))
                            } else {
                                @noChargesDueContent(viewModel.whatYouOweChargesList.getEarliestTaxYearAndAmountByDueDate)
                        }






                        <div class="govuk-tabs" data-module="govuk-tabs" id="self-assessment-charges-tabs">
                            <h2 class="govuk-tabs__title">
                                Contents
                            </h2>
                            <ul class="govuk-tabs__list">
                                @if(viewModel.overdueAccruingInterestOrOutstandingChargesListNonEmpty) {
                                    <li class="govuk-tabs__list-item govuk-tabs__list-item--selected">
                                        <a class="govuk-tabs__tab" href="#charges-due-now">
                                        @getMessage("charges-due-now")
                                        </a>
                                    </li>
                                }
                                @if(viewModel.chargesDueWithin30DaysListNonEmpty) {
                                <li class="govuk-tabs__list-item">
                                    <a class="govuk-tabs__tab" href="#charges-due-in-30-days">
                                        @getMessage("charges-due-in-30-days")
                                    </a>
                                </li>
                                }
                                @if(viewModel.chargesDueAfter30DaysListNonEmpty) {
                                    <li class="govuk-tabs__list-item">
                                        <a class="govuk-tabs__tab" href="#charges-due-later">
                                        @getMessage("charges-to-pay-later")
                                        </a>
                                    </li>
                                }
                            </ul>

                            @if(viewModel.overdueAccruingInterestOrOutstandingChargesListNonEmpty) {
                                <div class="govuk-tabs__panel" id="charges-due-now">
                                    <table class="govuk-table" id="charges-due-now-table">
                                        @tableHead("over-due-payments-table-head", true)
                                        <caption class="govuk-table__caption govuk-visually-hidden">@getMessage("charges-due-now")</caption>
                                        <tbody class="govuk-table__body">
                                            @if(viewModel.whatYouOweChargesList.bcdChargeTypeDefinedAndGreaterThanZero) {
                                                <tr class="govuk-table__row" id="balancing-charge-type-0">
                                                    <td class="govuk-table__cell">@{
                                                        viewModel.whatYouOweChargesList.getRelevantDueDate.toLongDateShort
                                                    }</td>
                                                    <td class="govuk-table__cell">
                                                        @p(id = Some("balancing-charge"))(Html(getMessage("balaytryncingCharge.text")))
                                                        @p(id = Some("pre-mtd-digital"))(Html(getMessage("pre-mtdytry-digital")))
                                                    </td>
                                                    <td class="govuk-table__cell">
                                                    @getMessage("pre-mtd-year", (viewModel.currentTaxYear.endYear - 2).toString, (viewModel.currentTaxYear.endYear - 1).toString)
                                                    </td>
                                                    <td class="govuk-table__cell govuk-table__cell--numeric">
                                                    @if(viewModel.whatYouOweChargesList.outstandingChargesModel.get.getAciChargeWithTieBreaker.isDefined
                                                            && viewModel.whatYouOweChargesList.getRelevantDueDate.isBefore(viewModel.currentDate)) @{
                                                        viewModel.whatYouOweChargesList.getAciChargeWithTieBreakerChargeAmount.toCurrency
                                                    }
                                                    </td>
                                                    <td class="govuk-table__cell govuk-table__cell--numeric">@{
                                                        viewModel.whatYouOweChargesList.outstandingChargesModel.get.bcdChargeType.get.chargeAmount.toCurrency
                                                    }</td>
                                                </tr>
                                            }
                                            @for((charge, index) <- viewModel.overdueChargesWithIndex) {
                                                @tableRowWithInterest(s"due-$index", charge, index, "taxYearSummary-link")
                                            }
                                            <tr class="govuk-table__header">
                                                <td class="govuk-table__header" colspan="2" id="total-amount">
                                                @getMessage("table.total-amount", viewModel.whatYouOweChargesList.balanceDetails.overDueAmount.toCurrencyString)
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>

                                    <div class="govuk-inset-text" id="overdue-payment-text">
                                        <div>
                                        @getMessage("overdue-inset-text-1")
                                        </div>
                                        <br>
                                        <div>
                                        @getMessage("overdue-inset-text-2")
                                        </div>
                                    </div>

                                    @if(user.saUtr.isDefined && !user.isAgent()) {
                                        @paymentButton(viewModel.earliestTaxYearAndAmountByDueDate)
                                    }
                                </div>
                            }

                            @if(viewModel.chargesDueWithin30DaysListNonEmpty) {
                                <div class="govuk-tabs__panel" id="charges-due-in-30-days">
                                    <table class="govuk-table">
                                        @tableHead("due-in-30-days-payments-table-head", false)
                                        <tbody class="govuk-table__body">
                                            @for((charge, index) <- viewModel.chargesDueWithin30DaysWithIndex) {
                                                @tableRowWithoutInterest(s"due-30-days-$index", charge, index, "taxYearSummary-link")
                                            }
                                            <tr class="govuk-table__header">
                                                <td class="govuk-table__header" colspan="2">
                                                @getMessage("table.total-amount", viewModel.whatYouOweChargesList.balanceDetails.balanceDueWithin30Days.toCurrencyString)
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>

                                    @if(user.saUtr.isDefined && !user.isAgent() && !viewModel.overdueAccruingInterestOrOutstandingChargesListNonEmpty) {
                                        <div class="govuk-inset-text" id="30-days-payment-text">
                                            <div>
                                            @getMessage("overdue-inset-text-1")
                                            </div>
                                            <br>
                                            <div>
                                            @getMessage("overdue-inset-text-2")
                                            </div>
                                        </div>

                                        @viewModel.earliestTaxYearAndAmountByDueDate.map { taxYearWithAmount =>
                                            <div id="payment-button">
                                                @link(
                                                    controllers.routes.PaymentController.paymentHandoff(taxYearWithAmount.amount.toPence, origin).url,
                                                    messageKey = getPrefix("payNow"),
                                                    classes = "govuk-button",
                                                    role = Some("button"),
                                                    id = Some("payment-button-link")
                                                )
                                            </div>
                                        }
                                    }
                                </div>
                            }

                            @if(viewModel.chargesDueAfter30DaysListNonEmpty) {
                                <div class="govuk-tabs__panel" id="charges-due-later">
                                    <table class="govuk-table">
                                        @tableHead("charges-due-later-table-head", showInterest = false)
                                        <tbody class="govuk-table__body">
                                        @for((charge, index) <- viewModel.chargesDueAfter30DaysWithIndex) {
                                            @tableRowWithoutInterest(s"due-$index", charge, index, "taxYearSummary-link")
                                        }
                                        </tbody>
                                    </table>

                                    @if(user.saUtr.isDefined && !user.isAgent() && !viewModel.overdueAccruingInterestOrOutstandingChargesListNonEmpty && !viewModel.chargesDueWithin30DaysListNonEmpty) {

                                        @paymentButton(viewModel.earliestTaxYearAndAmountByDueDate)
                                    }
                                </div>
                            }
                            </div>

                            @getPaymentPlanSection()
                        }

                        @if(!viewModel.whatYouOweChargesList.isChargesListEmpty) {
                            @dunningLockParagraph(viewModel.dunningLock, viewModel.hasLpiWithDunningLock)
                        }

                        @claimToAdjustPoaSection(viewModel)

                        @viewModel.whatYouOweChargesList.codedOutDocumentDetail.map { codedOutDocumentDetail =>
                            <div id="coding-out-wrapper">
                                @govukInsetText(InsetText(content = HtmlContent(codingOutInsetContent(codedOutDocumentDetail))))
                            </div>
                        }
                        @if(viewModel.whatYouOweChargesList.isChargesListEmpty) {
                            @saNoteParagraph()
                        }

                    </div>
                    @if(!viewModel.whatYouOweChargesList.isChargesListEmpty) {
                        @saNoteParagraph()
                    }
                    @viewModel.whatYouOweChargesList.availableCredit.map { availableCreditAmt =>
                        @unallocatedCreditParagraphContent(availableCreditAmt.toCurrencyString, viewModel.creditAndRefundUrl)
                    }

                }

                @if(viewModel.creditAndRefundEnabled) {
                    @viewModel.whatYouOweChargesList.availableCredit.map { ac =>
                        @availableCreditInAccount(ac.toCurrencyString, viewModel.creditAndRefundsControllerURL)
                    }
                }
            </div>
        </div>
    }
