@*
 * Copyright 2023 HM Revenue & Customs
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *@

@import models.financialDetails.Payment
@import java.time.LocalDate
@import implicits.ImplicitCurrencyFormatter._
@import implicits.ImplicitDateFormatter
@import implicits.ImplicitDateFormatterImpl
@import models.financialDetails.DocumentDetailWithDueDate
@import models.financialDetails.FinancialDetailsModel
@import models.financialDetails._
@import models.repaymentHistory.PaymentHistoryEntry
@import uk.gov.hmrc.govukfrontend.views.html.components._
@import views.html.layouts.unifiedLayout
@import views.html.components._
@import models.paymentCreditAndRefundHistory.PaymentCreditAndRefundHistoryViewModel
@import _root_.implicits.HtmlFormatter.NbspString
@import viewUtils.ExternalUrlHelper
@import views.html.partials.paymentHistory.PaymentDescription

@this(
    paymentDescription: PaymentDescription,
    mainTemplate: unifiedLayout,
    appConfig: config.FrontendAppConfig,
    implicitDateFormatter: ImplicitDateFormatterImpl,
    h1: h1,
    p: p,
    link: link,
    govukAccordion : GovukAccordion,
    govukTable : GovukTable
)

@(groupedPayments: List[(Int, List[PaymentHistoryEntry])], viewModel: PaymentCreditAndRefundHistoryViewModel, paymentHistoryAndRefundsEnabled: Boolean = false, backUrl: String, saUtr: Option[String], isAgent: Boolean = false,
btaNavPartial: Option[Html] = None, origin: Option[String] = None)(implicit request: Request[_], messages: Messages)
@import implicitDateFormatter.longDate

@paymentHistoryInfo(messageInfo: String, infoLink: => String, infoLinkText: String) = {
    @if(saUtr.isDefined) {
        @p() {
            @messages(messageInfo)
            @link(link = infoLink, messageKey = infoLinkText, outerMessage = ".", rel = Some ("noreferrer noopener"), target = Some ("_blank") )
            @if(isAgent){
                @messages(s"$messageInfo.2")
            }
        }
    }
}

@getMessage(key: String, args: String*) = @{
    messages(s"paymentHistory.$key", args: _*)
}

@headingContent(year: Int) = {
    <span id="accordion-with-summary-sections-heading-@year">
       @messages("paymentHistory.activity", year.toString)
    </span>
}

@bodyContent(year: Int, yearPayments: List[PaymentHistoryEntry]) = {
    @govukTable(Table(
        head = Some(Seq(
            HeadCell(
                content = Text(messages("paymentHistory.table.header.date"))
            ),
            HeadCell(
                content = Text(messages("paymentHistory.table.header.description"))
            ),
            HeadCell(
                content = Text(messages("paymentHistory.tableHead.taxYear"))
            ),
            HeadCell(
                content = Text(messages("paymentHistory.table.header.amount"))
            )
        )),
        rows = yearPayments.sortBy(_.date).reverse.zipWithIndex.map{ case (payment, index) => Seq(
            TableRow(
                content = HtmlContent(payment.date.toLongDateShort.toNonBreaking.toString),
                attributes = Map("data-th" -> messages("paymentHistory.table.header.date"))
            ),
            TableRow(
                content = HtmlContent(paymentDescription(payment, yearPayments, index)),
                attributes = Map("id" -> s"payment-$index", "data-th" -> messages("paymentHistory.table.header.description"))
            ),
            TableRow(
                content = HtmlContent(messages("paymentHistory.cell.taxYear", payment.getTaxYear.startYear.toString, payment.getTaxYear.endYear.toString).toNonBreaking),
                attributes = Map("id" -> s"tax-year-cell-$index", "data-th" -> messages("paymentHistory.tableHead.taxYear"))
            ),
            TableRow(
                content = HtmlContent(payment.amount.map(_.abs.toCurrency).getOrElse(getMessage("unknown")).toString),
                attributes = Map("data-th" -> messages("paymentHistory.table.header.amount")),
                format = Some("numeric")
            )
        )},
        classes = "govuk-!-margin-bottom-8 govuk-table--responsive",
        caption = Some(messages("paymentHistory.button", year.toString)),
        captionClasses = "govuk-table__caption--m",
    ))
}

@getItems = @{
    groupedPayments.zipWithIndex.map {
        case ((year: Int, yearPayments: List[PaymentHistoryEntry]), index) =>
            Section(
                expanded = Some(index == 0),
                headingContent = HtmlContent(headingContent(year)),
                content = HtmlContent(bodyContent(year, yearPayments))
            )
    }
}

@mainTemplate(
    pageTitle = viewModel.title(),
    backUrl = Some(backUrl),
    isAgent = isAgent,
    btaNavPartial = btaNavPartial,
    useFallbackBackLink = true
) {

    @h1(msg = messages(viewModel.title()))

    @if(!isAgent) {
      @if(saUtr.isDefined) {
         @paymentHistoryInfo("PaymentHistory.classicSA", appConfig.saViewLandPService(saUtr.get), "taxYears.oldSa.content.link")
        }
    } else {
      @paymentHistoryInfo("paymentHistory.info", ExternalUrlHelper.saForAgents, "taxYears.oldSa.agent.content.2")
    }

    @if(!isAgent && paymentHistoryAndRefundsEnabled) {
        <div id="refundstatus" class="govuk-inset-text">
            @getMessage("check-refund-1")
            @link(link =  s"${controllers.routes.PaymentHistoryController.refundStatus().url}",
            messageKey = "paymentHistory.check-refund-2", classes = "govuk-link",
            role=Some("button")
            )
            @getMessage("check-refund-3")
        </div>
    }

    @{groupedPayments match {
        case Nil         =>
        case head :: Nil => bodyContent(head._1, head._2)
        case _           => {
            govukAccordion(Accordion(
                id = "accordion-default",
                rememberExpanded = Some(true),
                items = getItems
            ))
        }
    }}
}
