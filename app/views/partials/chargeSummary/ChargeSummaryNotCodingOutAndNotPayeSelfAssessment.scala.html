@*
 * Copyright 2023 HM Revenue & Customs
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *@

@import _root_.implicits.ImplicitDateFormatterImpl
@import _root_.implicits.ImplicitCurrencyFormatter.CurrencyFormatter
@import views.html.components._
@import services.DateServiceInterface
@import uk.gov.hmrc.govukfrontend.views.viewmodels.table._
@import uk.gov.hmrc.govukfrontend.views.html.components.GovukTable
@import uk.gov.hmrc.govukfrontend.views.viewmodels.content.Text
@import uk.gov.hmrc.govukfrontend.views.viewmodels.content.HtmlContent
@import implicits.HtmlFormatter.NbspString
@import uk.gov.hmrc.govukfrontend.views.viewmodels.tag.Tag
@import uk.gov.hmrc.govukfrontend.views.html.components.GovukTag
@import models.financialDetails.Accepted


@this(
    p: p,
    link: link,
    implicitDateFormatter: ImplicitDateFormatterImpl,
    govukTag: GovukTag,
    govukTable: GovukTable
)

@(
    chargeItem: models.financialDetails.ChargeItem,
    interestCharge: Boolean,
    taxYearFromCodingOut: String,
    taxYearToCodingOut: String,
    appConfig: config.FrontendAppConfig
)(implicit messages: Messages, dateService: DateServiceInterface)

@import implicitDateFormatter.longDate

@govukTable(Table(
    rows = Seq(
        Seq(
            TableRow(content = Text(messages(s"chargeSummary.${if(chargeItem.isCredit) "date" else "dueDate"}"))),
            TableRow(
                classes = "govuk-!-text-align-right",
                content = HtmlContent({
                    if(chargeItem.isOverdue() && !chargeItem.checkIsPaid(interestCharge)) {
                        govukTag(Tag(
                            content = Text(messages("chargeSummary.overdue")),
                            classes = "govuk-tag--red"
                        ))
                    }
                    (interestCharge match {
                        case true                                            => chargeItem.getInterestFromDate.toLongDate
                        case _ if chargeItem.isBalancingChargeWithoutSubType => chargeItem.getDueDateForNonZeroBalancingCharge.fold(messages("tax-year-summary.na"))(_.toLongDate)
                        case _ if chargeItem.isCredit                        => chargeItem.dueDate.fold(messages("chargeSummary.na"))(_.toLongDateShort)
                        case _                                               => chargeItem.dueDate.fold(messages("chargeSummary.na"))(_.toLongDate)
                    }).toNonBreaking}
                )
            )
        ),
        if(interestCharge) {
            Seq(
                TableRow(content = Text(messages("chargeSummary.lpi.interestPeriod"))),
                TableRow(
                    format = Some("numeric"),
                    content = HtmlContent(messages(
                        "chargeSummary.lpi.interestPeriod.dates",
                        chargeItem.getInterestFromDate.toLongDateShort,
                        chargeItem.getInterestEndDate.toLongDateShort
                    ).toNonBreaking)
                )
            )
        } else Nil,
        Seq(
            TableRow(content = Text(messages(s"chargeSummary.${if(chargeItem.subTransactionType.isDefined) "paymentAmountCodingOut" else "paymentAmount"}"))),
            TableRow(
                format = Some("numeric"),
                content = HtmlContent({
                    if(interestCharge) chargeItem.getLatePaymentInterestAmount.toCurrency
                    else               chargeItem.originalAmount.abs.toCurrency
                })
            )
        ),
        if(!chargeItem.isCredit) {
            Seq(
                TableRow(content = Text(messages("chargeSummary.remainingDue"))),
                TableRow(
                    format = Some("numeric"),
                    content = HtmlContent(
                        chargeItem.subTransactionType.contains(Accepted) match {
                            case true                => Html(messages("chargeSummary.codingOutRemainingToPay", taxYearFromCodingOut, taxYearToCodingOut))
                            case _ if interestCharge => chargeItem.interestRemainingToPay.toCurrency
                            case _                   => chargeItem.remainingToPay.toCurrency
                        }
                    )
                )
            )
        } else Nil
    ),
    firstCellIsHeader = true
))
