@*
 * Copyright 2023 HM Revenue & Customs
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *@

@import views.html.components._
@import auth.MtdItUser
@import uk.gov.hmrc.govukfrontend.views.html.components.GovukInsetText
@import uk.gov.hmrc.govukfrontend.views.html.components._
@import views.helpers.whatYouOweChargesSummary.WYOMessagesHelper._
@import models.financialDetails.WhatYouOweViewModel
@import _root_.implicits.ImplicitCurrencyFormatter._

@this(
        h2: h2,
        p: p,
        link: link,
        govukInsetText: GovukInsetText,
        govukButton: GovukButton
)

@(
        isAgent: Boolean,
        origin: Option[String],
        viewModel: WhatYouOweViewModel
)(
    implicit messages: Messages,
    user: MtdItUser[_]
)

@overdueInsetText = {
    @p(id = Some("overdue-inset-migrated-1"))(content = Html(messages("selfAssessmentCharges.overdue-inset-text-1")))
    @p(id = Some("overdue-inset-migrated-2"))(content = Html(messages("selfAssessmentCharges.overdue-inset-text-2")))
}

@viewModel.whatYouOweChargesList.codedOutDetails.map { codedOutDetails =>
    @h2(getMessage("payments-made-heading"))
    @p(id = Some("payments-made-migrated"))(Html(
        getMessage("payments-made-body-1", codedOutDetails.amountCodedOut.toCurrencyString, (viewModel.currentTaxYear - 1).toString, viewModel.currentTaxYear.toString) +
                link(link = viewModel.paymentHistoryControllerURL(isAgent, origin),
                    messageKey = getMessage("payments-made-link"),
                    id = Some("payments-made-migrated-link"),
                    rel = Some("noreferrer noopener")).toString() +
                getMessage("payments-made-body-2")
    ))
}

@insetTextAndButton(amount: BigDecimal) = {
    @govukInsetText(InsetText(
        content = HtmlContent(overdueInsetText)
    ))
    @govukButton(Button(
        id = Some("payment-button"),
        content = Text(getMessage("payNow")),
        href = Some(viewModel.paymentHandOffUrl(amount.toPence))
    ))
}

@if(viewModel.utr.isDefined && !user.isAgent()) {
    @(for {
        (_, amount) <- viewModel.whatYouOweChargesList.getEarliestTaxYearAndAmountByDueDate
    } yield {
        insetTextAndButton(amount)
    })
}
