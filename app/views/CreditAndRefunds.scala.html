@*
 * Copyright 2022 HM Revenue & Customs
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *@

@*
* Copyright 2022 HM Revenue & Customs
*
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*     http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*@

@import implicits.ImplicitDateFormatterImpl
@import implicits.ImplicitCurrencyFormatter._
@import models.financialDetails.WhatYouOweChargesList
@import java.time.LocalDate
@import models.financialDetails.DocumentDetailWithDueDate
@import models.financialDetails._
@import auth.MtdItUser
@import views.html.layouts.unifiedLayout
@import views.html.components._
@import exceptions.MissingFieldException
@import uk.gov.hmrc.govukfrontend.views.html.components._


@this(
mainTemplate: unifiedLayout,
implicitDateFormatter: ImplicitDateFormatterImpl,
appConfig: config.FrontendAppConfig,
h1: h1,
h2: h2,
p: p,
link: link,
govukInsetText : GovukInsetText
)

@(creditCharges: List[(DocumentDetailWithDueDate, FinancialDetail)], balance: Option[BalanceDetails],
isAgent: Boolean = false, backUrl: String, isMFACreditsAndDebitsEnabled: Boolean = false)(implicit request: Request[_], user: MtdItUser[_], messages: Messages)
@import implicitDateFormatter.longDate

@getControllerHref(credit: DocumentDetail, isAgent: Boolean) = @{
if(isAgent) {
controllers.routes.PaymentAllocationsController.viewPaymentAllocationAgent(credit.transactionId)
} else {
controllers.routes.PaymentAllocationsController.viewPaymentAllocation(credit.transactionId)
}
}

@getCreditsSummaryControllerHref(credit: DocumentDetail, isAgent: Boolean) = @{
if(isAgent) {
controllers.routes.CreditsSummaryController.showAgentCreditsSummary(credit.documentDate.getYear)
} else {
controllers.routes.CreditsSummaryController.showCreditsSummary(credit.documentDate.getYear)
}
}

@getWhatYouOwe(isAgent: Boolean) = @{
if(isAgent) {
controllers.routes.WhatYouOweController.showAgent().url
} else {
controllers.routes.WhatYouOweController.show().url
}
}

@mainTemplate(
pageTitle = messages("credit-and-refund.heading"),
backUrl = Some(backUrl),
isAgent = isAgent,
useFallbackBackLink = true
) {


@h1(msg = "credit-and-refund.heading")

@if(balance.isDefined){
@if(balance.get.availableCredit.get != 0){
<h2 class="govuk-heading-m">
    <span class="govuk-body"> @messages("credit-and-refund.subHeading.has-credits-1") </span>
    @{balance.get.availableCredit.get.toCurrency}
    <span class="govuk-body">@messages("credit-and-refund.subHeading.has-credits-2")</span>
</h2>
} else {
<h2 class="govuk-heading-m">@{balance.get.firstPendingAmountRequested.get.toCurrency}
    <span class="govuk-body"> @messages("credit-and-refund.subHeading.has-no-credits")</span>
</h2>
}

<ul class="govuk-list govuk-list--bullet">
    @for(charge <- creditCharges){
    @if(isMFACreditsAndDebitsEnabled){
    @if(charge._1.documentDetail.validMFACreditDescription()) {
    <li>
        <dt class="govuk-heading-s">
            @charge._1.documentDetail.paymentOrChargeCredit.get.toCurrencyString
            <span class="govuk-body">
                @messages("credit-and-refund.credit-from-hmrc-title-prt-1")
                <a href="@getCreditsSummaryControllerHref(charge._1.documentDetail, isAgent)"
                   class="govuk-link">@messages("credit-and-refund.credit-from-hmrc-title-prt-2")
                </a>
            </span>
        </dt>
    </li>
    }
    @if(!charge._1.documentDetail.validMFACreditDescription()) {
    <li>
        <dt class="govuk-heading-s">
            @charge._1.documentDetail.paymentOrChargeCredit.get.toCurrencyString
            <span class="govuk-body">@messages("credit-and-refund.payment")
            <a href="@getControllerHref(charge._1.documentDetail, isAgent)"
               class="govuk-link">@charge._1.dueDate.get.toLongDate
            </a>
        </span>
        </dt>
    </li>
    }
    }
    @if(!isMFACreditsAndDebitsEnabled && !charge._1.documentDetail.validMFACreditDescription()){
    <li>
        <dt class="govuk-heading-s">
            @charge._1.documentDetail.paymentOrChargeCredit.get.toCurrencyString
            <span class="govuk-body">@messages("credit-and-refund.payment") <a
                    href="@getControllerHref(charge._1.documentDetail, isAgent)" class="govuk-link">@charge._1.dueDate.get.toLongDate</a>
        </span>
        </dt>
    </li>
    }
    }

    @{balance.get.firstPendingAmountRequested map { amount =>
    if(messages.lang.language.toLowerCase().equals("cy")){
    <li>
        <dt class="govuk-heading-s">
            <span class="govuk-body">{messages("credit-and-refund.refundProgress-prt-1")}</span>
            {amount.toCurrencyString}
            <span class="govuk-body">{messages("credit-and-refund.refundProgress-prt-2")}</span>
        </dt>
    </li>
    }
    else{
    <li>
        <dt class="govuk-heading-s">{amount.toCurrencyString}
            <span class="govuk-body">{messages("credit-and-refund.refundProgress")}</span>
        </dt>
    </li>
    }
    }
    }
    @{ balance.get.secondPendingAmountRequested map { amount =>
    if(messages.lang.language.toLowerCase().equals("cy")){
    <li>
        <dt class="govuk-heading-s">
            <span class="govuk-body">{messages("credit-and-refund.refundProgress-prt-1")}</span>
            {amount.toCurrencyString}
            <span class="govuk-body">{messages("credit-and-refund.refundProgress-prt-2")}</span>
        </dt>
    </li>
    }
    else{
    <li>
        <dt class="govuk-heading-s">{amount.toCurrencyString}
            <span class="govuk-body">{messages("credit-and-refund.refundProgress")}</span>
        </dt>
    </li>
    }
    }
    }
</ul>
@if(balance.get.availableCredit.get != 0){
@p(){
<h2 class="govuk-heading-m">
    @messages("credit-and-refund.bullet-text-intro")
</h2>
}

<ul class="govuk-list">
    <li>
        @p(){
        @messages("credit-and-refund.bullet-one-prt-1")
        @link(link = getWhatYouOwe(isAgent),
        messageKey = "credit-and-refund.bullet-one-link",
        target = None)
        @messages("credit-and-refund.bullet-one-prt-2")
        }
    </li>
    <li>
        @messages("credit-and-refund.bullet-two-prt-1")
        @{balance.get.availableCredit.get.toCurrency}
        @messages("credit-and-refund.bullet-two-prt-2")
    </li>
</ul>
}
} else {
@p(){
@messages("credit-and-refund.no-credit")
}
}

<div class="govuk-button-group">
    @if(balance.isDefined){
    @if(balance.get.availableCredit.get != 0){
    @link(link = "https://www.tax.service.gov.uk/self-assessment-repayment/repayment-amount",
    messageKey = "credit-and-refund.claim-refund-btn", classes = "govuk-button", role=Some("button"))
    }
    }

    @link(link = "https://www.tax.service.gov.uk/self-assessment-repayment/repayment-status",
    messageKey = "credit-and-refund.check-refund-btn", classes = "govuk-button govuk-button--secondary",
    role=Some("button")
    )
</div>

}