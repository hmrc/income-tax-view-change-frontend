@*
 * Copyright 2022 HM Revenue & Customs
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *@

@import _root_.implicits.ImplicitDateFormatterImpl
@import _root_.implicits.ImplicitCurrencyFormatter._
@import models.financialDetails.DocumentDetailWithDueDate
@import models.financialDetails._
@import auth.MtdItUser
@import views.html.layouts.unifiedLayout
@import views.html.components._
@import exceptions.MissingFieldException
@import uk.gov.hmrc.govukfrontend.views.html.components._


@this(
    mainTemplate: unifiedLayout,
    implicitDateFormatter: ImplicitDateFormatterImpl,
    appConfig: config.FrontendAppConfig,
    h1: h1,
    h2: h2,
    p: p,
    link: link,
    govukInsetText : GovukInsetText
)

@(creditCharges: List[(DocumentDetailWithDueDate, FinancialDetail)], balance: Option[BalanceDetails],
    isAgent: Boolean = false, backUrl: String, isMFACreditsAndDebitsEnabled: Boolean = false)(implicit request: Request[_], user: MtdItUser[_], messages: Messages)
@import implicitDateFormatter.longDate

@getControllerHref(credit: DocumentDetail, isAgent: Boolean) = @{
    if(isAgent) {
        controllers.routes.PaymentAllocationsController.viewPaymentAllocationAgent(credit.transactionId)
    } else {
        controllers.routes.PaymentAllocationsController.viewPaymentAllocation(credit.transactionId)
    }
}

@getCreditsSummaryControllerHref(credit: DocumentDetail, isAgent: Boolean) = @{
    if(isAgent) {
        controllers.routes.CreditsSummaryController.showAgentCreditsSummary(credit.documentDate.getYear)
    } else {
        controllers.routes.CreditsSummaryController.showCreditsSummary(credit.documentDate.getYear)
    }
}

@getWhatYouOwe(isAgent: Boolean) = @{
    if(isAgent) {
        controllers.routes.WhatYouOweController.showAgent().url
    } else {
        controllers.routes.WhatYouOweController.show().url
    }
}

@creditAndRefundRefundProgressHtml(amount: BigDecimal) = {
    @if(messages.lang.language.toLowerCase().equals("cy")) {
        <li>
            <p class="govuk-heading-s">
                <span class="govuk-body">@messages("credit-and-refund.refundProgress-prt-1")</span>
                @amount.toCurrencyString
                <span class="govuk-body">@messages("credit-and-refund.refundProgress-prt-2")</span>
            </p>
        </li>
    } else {
        <li>
            <p class="govuk-heading-s">@amount.toCurrencyString
                <span class="govuk-body">@messages("credit-and-refund.refundProgress")</span>
            </p>
        </li>
    }
}

@maybeCreditChargesHead = @{
    creditCharges.headOption.getOrElse(throw MissingFieldException("Credit Charges"))
}

@maybeBalancesDetails = @{
    balance.getOrElse(throw MissingFieldException("Balance"))
}

@maybeAvailableCredit = @{
    maybeBalancesDetails.availableCredit.getOrElse(throw MissingFieldException("Available Credit"))
}

@isUnallocatedCreditFromOnePayment = @{
    maybeBalancesDetails.unallocatedCredit.isDefined && maybeAvailableCredit != 0 && creditCharges.size == 1 && maybeCreditChargesHead._2.mainType.filter(_.contains("Payment on Account")).isDefined
}

@isUnallocatedCreditFromSingleCreditItem(financialDetails: FinancialDetail) = @{
    maybeBalancesDetails.unallocatedCredit.isDefined && maybeAvailableCredit != 0 && creditCharges.size == 1 && (MfaCreditUtils.validMFACreditType(financialDetails.mainType) || financialDetails.validCutoverCreditType())
}

@mainTemplate(
    pageTitle = messages("credit-and-refund.heading"),
    backUrl = Some(backUrl),
    isAgent = isAgent,
    useFallbackBackLink = true
) {

    @h1(msg = "credit-and-refund.heading")

    @if(balance.isDefined){
        @if(isUnallocatedCreditFromOnePayment) {
            <h2 class="govuk-heading-s">
                <span class="govuk-body"> @messages("credit-and-refund.subHeading.unallocated-credits-one-payment", maybeAvailableCredit.toCurrencyString, maybeCreditChargesHead._1.dueDate.getOrElse(throw MissingFieldException("Due Date")).toLongDate) </span>
                    <span class="govuk-body">
                        <a href="@getControllerHref(maybeCreditChargesHead._1.documentDetail, isAgent)" class="govuk-link">
                            @maybeCreditChargesHead._1.dueDate.getOrElse(throw MissingFieldException("Due Date")).toLongDate
                        </a>
                    </span>
            </h2>
        } else {
            @if(isUnallocatedCreditFromSingleCreditItem(maybeCreditChargesHead._2)) {
                <h2 class="govuk-heading-s">
                    <span class="govuk-body"> @messages("credit-and-refund.subHeading.unallocated-credits-single-credit", maybeAvailableCredit.toCurrencyString, maybeCreditChargesHead._1.dueDate.getOrElse(throw MissingFieldException("Due Date")).toLongDate) </span>
                    <span class="govuk-body">
                        <a href="@getCreditsSummaryControllerHref(maybeCreditChargesHead._1.documentDetail, isAgent)" class="govuk-link">
                            @messages("credit-and-refund.credit-from-hmrc-title-prt-2")
                        </a>
                    </span>
                </h2>
            } else {
                @if(maybeAvailableCredit != 0) {
                    <h2 class="govuk-heading-s">
                        <span class="govuk-body"> @messages("credit-and-refund.subHeading.has-credits-1") </span>
                            @maybeAvailableCredit.toCurrency
                        <span class="govuk-body"> @messages("credit-and-refund.subHeading.has-credits-2")</span>
                    </h2>
                } else {
                    <h2 class="govuk-heading-s">@{
                        maybeBalancesDetails.firstPendingAmountRequested.getOrElse(throw MissingFieldException("First Pending Amount")).toCurrency
                    }
                        <span class="govuk-body"> @messages("credit-and-refund.subHeading.has-no-credits")</span>
                    </h2>
                }
            }
        }


            @if(!isUnallocatedCreditFromOnePayment) {
                <ul class="govuk-list govuk-list--bullet" id="credits-list">
                    @for((charge, index) <- creditCharges.zipWithIndex) {
                    @if(charge._2.validMFACreditType() && !isUnallocatedCreditFromSingleCreditItem(maybeCreditChargesHead._2)) {
                        @if(isMFACreditsAndDebitsEnabled) {
                            <li>
                                <p class="govuk-heading-s">
                                    @charge._1.documentDetail.paymentOrChargeCredit.getOrElse(throw MissingFieldException("Payment Or Charge Credit")).toCurrencyString
                                    <span class="govuk-body">
                                        @messages("credit-and-refund.credit-from-hmrc-title-prt-1")
                                        <a id="credit-and-refund-@index" href="@getCreditsSummaryControllerHref(charge._1.documentDetail, isAgent)" class="govuk-link">
                                            @messages("credit-and-refund.credit-from-hmrc-title-prt-2")
                                            <span class="govuk-visually-hidden"> @index</span>
                                        </a>
                                    </span>
                                </p>
                            </li>
                        }
                    } else {
                        @if(charge._2.validCutoverCreditType() && !isUnallocatedCreditFromSingleCreditItem(maybeCreditChargesHead._2)) {
                            <li>
                                <p class="govuk-heading-s">
                                    @charge._1.documentDetail.paymentOrChargeCredit.getOrElse(throw MissingFieldException("Payment Or Charge Credit")).toCurrencyString
                                    <span class="govuk-body"> @messages("credit-and-refund.credit-from-hmrc-title-prt-1")
                                        <a id="credit-and-refund-@index" href="@getCreditsSummaryControllerHref(charge._1.documentDetail, isAgent)"
                                        class="govuk-link">@messages("paymentHistory.paymentFromEarlierYear")
                                            <span class="govuk-visually-hidden"> @index</span>
                                        </a>
                                    </span>
                                </p>
                            </li>
                        } else {
                            @if(!isUnallocatedCreditFromSingleCreditItem(maybeCreditChargesHead._2)) {
                                <li>
                                    <p class="govuk-heading-s">
                                        @charge._1.documentDetail.paymentOrChargeCredit.getOrElse(throw MissingFieldException("Payment Or Charge Credit")).toCurrencyString
                                        <span class="govuk-body">@messages("credit-and-refund.payment")
                                            <a href="@getControllerHref(charge._1.documentDetail, isAgent)"
                                            class="govuk-link">@charge._1.dueDate.getOrElse(throw MissingFieldException("Due Date")).toLongDate
                                            </a>
                                        </span>
                                    </p>
                                </li>
                            }
                        }
                    }
                }

                @{
                    if(maybeBalancesDetails.firstPendingAmountRequested > maybeBalancesDetails.secondPendingAmountRequested){
                        maybeBalancesDetails.firstPendingAmountRequested map { amount =>
                            if(messages.lang.language.toLowerCase().equals("cy")){
                                <li>
                                    <p class="govuk-heading-s">
                                        <span class="govuk-body">{messages("credit-and-refund.refundProgress-prt-1")}</span>
                                            {amount.toCurrencyString}
                                        <span class="govuk-body">{messages("credit-and-refund.refundProgress-prt-2")}</span>
                                    </p>
                                </li>
                            }
                            else{
                                <li>
                                    <p class="govuk-heading-s">{amount.toCurrencyString}
                                        <span class="govuk-body">{messages("credit-and-refund.refundProgress")}</span>
                                    </p>
                                </li>
                            }
                        }
                    }
                    else {
                        maybeBalancesDetails.secondPendingAmountRequested map { amount =>
                            creditAndRefundRefundProgressHtml(amount)
                        }
                    }
                }

                @{
                    if(maybeBalancesDetails.firstPendingAmountRequested < maybeBalancesDetails.secondPendingAmountRequested){
                        maybeBalancesDetails.firstPendingAmountRequested map { amount =>
                            creditAndRefundRefundProgressHtml(amount)
                        }
                    }
                    else {
                        maybeBalancesDetails.secondPendingAmountRequested map { amount =>
                            creditAndRefundRefundProgressHtml(amount)
                        }
                    }
                }
            </ul>
        }


        @if(maybeAvailableCredit != 0){
            @p(){
                <h2 class="govuk-heading-m">
                    @messages("credit-and-refund.bullet-text-intro")
                </h2>
            }

            <ul class="govuk-list">
                <li>
                    @p(){
                        @messages("credit-and-refund.bullet-one-prt-1")
                        @link(link = getWhatYouOwe(isAgent),
                            messageKey = "credit-and-refund.bullet-one-link",
                            target = None)
                        @messages("credit-and-refund.bullet-one-prt-2")
                    }
                </li>
                <li>
                    @messages("credit-and-refund.bullet-two-prt-1")
                    @maybeAvailableCredit.toCurrency
                    @messages("credit-and-refund.bullet-two-prt-2")
                </li>
            </ul>
        }
    } else {
        @p(){
            @messages("credit-and-refund.no-credit")
        }
    }

        <div class="govuk-button-group">
            @if(balance.isDefined){
                @if(maybeAvailableCredit != 0){
                    @link(link = "https://www.tax.service.gov.uk/self-assessment-repayment/repayment-amount",
                        messageKey = "credit-and-refund.claim-refund-btn", classes = "govuk-button", role=Some("button"))
                }
            }

            @link(link = "https://www.tax.service.gov.uk/self-assessment-repayment/repayment-status",
                messageKey = "credit-and-refund.check-refund-btn", classes = "govuk-button govuk-button--secondary",
                role=Some("button")
                )
        </div>

    }