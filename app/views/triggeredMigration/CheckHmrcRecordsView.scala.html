@*
 * Copyright 2025 HM Revenue & Customs
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *@

@import views.html.layouts.unifiedLayout
@import uk.gov.hmrc.govukfrontend.views.html.components._
@import views.html.components._
@import models.triggeredMigration.viewModels.CheckHmrcRecordsViewModel
@import play.twirl.api.HtmlFormat
@import enums.IncomeSourceJourney.SelfEmployment

@this(
    mainTemplate: unifiedLayout,
    h1: h1,
    h2: h2,
    h3: h3,
    p: p,
    bulletList: bulletPointList,
    govukInsetText: GovukInsetText,
    link: link,
    continueButton: ContinueButton,
    hr: hr
)

@(viewModel: CheckHmrcRecordsViewModel)(implicit messages: Messages, user: auth.MtdItUser[_])

@ceaseSoleTraderBusinessURL(incomeSourceIdHash: String) = @{
    if(user.isAgent()) controllers.manageBusinesses.cease.routes.DeclareIncomeSourceCeasedController.showAgent(Some(incomeSourceIdHash), SelfEmployment, isTriggeredMigration = true).url
    else controllers.manageBusinesses.cease.routes.DeclareIncomeSourceCeasedController.show(Some(incomeSourceIdHash), SelfEmployment, isTriggeredMigration = true).url
}

@soleTraderSection = {
    @h3(messages("triggered-migration.check-hmrc-records.soleTrader.heading"), classes = "govuk-heading-m", optId = Some("sole-trader-heading"))
    @p(id = Some("sole-trader-guidance")){@messages("triggered-migration.check-hmrc-records.soleTrader.guidance")}

    @for((business, index) <- viewModel.soleTraderBusinesses.zipWithIndex) {
        <div class="govuk-summary-card">
            <div class="govuk-summary-card__title-wrapper">
                <h2 class="govuk-summary-card__title" id="sole-trader-business-@index">
                @business.incomeSource.getOrElse(messages("triggered-migration.check-hmrc-records.soleTrader.unknown"))
                </h2>
                <ul class="govuk-summary-card__actions">
                    <li class="govuk-summary-card__action">
                        <a class="govuk-link" id="sole-trader-cease-link-@index" href=@ceaseSoleTraderBusinessURL(business.incomeSourceId.toHash.hash)>@messages("triggered-migration.check-hmrc-records.soleTrader.cease.link")</a>
                    </li>
                </ul>
            </div>
            <div class="govuk-summary-card__content">
                <dl class="govuk-summary-list">
                    <div class="govuk-summary-list__row">
                        <dt class="govuk-summary-list__key" id="sole-trader-business-name-@index">
                        @messages("triggered-migration.check-hmrc-records.soleTrader.businessName")
                        </dt>
                        <dd class="govuk-summary-list__value" id="sole-trader-business-name-value-@index">
                        @business.businessName.getOrElse(messages("triggered-migration.check-hmrc-records.soleTrader.unknown"))
                        </dd>
                    </div>
                    <div class="govuk-summary-list__row">
                        <dt class="govuk-summary-list__key" id="sole-trader-business-state-@index">
                        @messages("triggered-migration.check-hmrc-records.soleTrader.businessState")
                        </dt>
                        <dd class="govuk-summary-list__value" id="sole-trader-business-state-value-@index">
                            <strong class="govuk-tag govuk-tag--turquoise">@messages("triggered-migration.check-hmrc-records.soleTrader.active")</strong>
                        </dd>
                    </div>
                </dl>
            </div>
        </div>
    }
    @link(link = "", messageKey = "triggered-migration.check-hmrc-records.soleTrader.add.link", id = Some("sole-trader-add-link"))
}

@propertyBusinessSection = @{
    (viewModel.hasActiveUkProperty, viewModel.hasActiveForeignProperty) match {
        case (true, true) => HtmlFormat.fill(Seq(ukPropertyContent, foreignPropertyContent))
        case (true, false) => HtmlFormat.fill(Seq(ukPropertyContent, addForeignPropertyLink))
        case (false, true) => HtmlFormat.fill(Seq(addUkPropertyLink, foreignPropertyContent))
        case _ => HtmlFormat.fill(Seq(noActivePropertiesContent, addUkPropertyLink, addForeignPropertyLink))
    }
}

@noActivePropertiesContent = { @p(id = Some("property-no-active-business-desc")){@messages("triggered-migration.check-hmrc-records.noActiveProperties")} }

@addUkPropertyLink() = { @p(id = Some("uk-property-add-link")){@link(link = "", messageKey = "triggered-migration.check-hmrc-records.ukProperty.add.link")}}

@ukPropertyContent = {
    <div class="govuk-summary-card">
        <div class="govuk-summary-card__title-wrapper">
            <h2 class="govuk-summary-card__title" id="uk-property-heading">
                @messages("triggered-migration.check-hmrc-records.ukProperty.heading")
            </h2>
            <ul class="govuk-summary-card__actions">
                <li class="govuk-summary-card__action" id="uk-property-cease-link">
                    <a class="govuk-link" href="#">@messages("triggered-migration.check-hmrc-records.ukProperty.cease.link")</a>
                </li>
            </ul>
        </div>
        <div class="govuk-summary-card__content">
            <dl class="govuk-summary-list">
                <div class="govuk-summary-list__row">
                    <dt class="govuk-summary-list__key" id="uk-property-business-state">
                        @messages("triggered-migration.check-hmrc-records.ukProperty.businessState")
                    </dt>
                    <dd class="govuk-summary-list__value" id="uk-property-business-state-value">
                        <strong class="govuk-tag govuk-tag--turquoise">@messages("triggered-migration.check-hmrc-records.ukProperty.active")</strong>
                    </dd>
                </div>
            </dl>
        </div>
    </div>
}

@addForeignPropertyLink() = { @p(id = Some("foreign-property-add-link")){@link(link = "", messageKey = "triggered-migration.check-hmrc-records.foreignProperty.add.link")}}

@foreignPropertyContent = {
    <div class="govuk-summary-card">
        <div class="govuk-summary-card__title-wrapper">
            <h2 class="govuk-summary-card__title" id="foreign-property-heading">
            @messages("triggered-migration.check-hmrc-records.foreignProperty.heading")
            </h2>
            <ul class="govuk-summary-card__actions">
                <li class="govuk-summary-card__action" id="foreign-property-cease-link">
                    <a class="govuk-link" href="#">@messages("triggered-migration.check-hmrc-records.foreignProperty.cease.link")</a>
                </li>
            </ul>
        </div>
        <div class="govuk-summary-card__content">
            <dl class="govuk-summary-list">
                <div class="govuk-summary-list__row">
                    <dt class="govuk-summary-list__key" id="foreign-property-business-state">
                    @messages("triggered-migration.check-hmrc-records.foreignProperty.businessState")
                    </dt>
                    <dd class="govuk-summary-list__value" id="foreign-property-business-state-value">
                        <strong class="govuk-tag govuk-tag--turquoise">@messages("triggered-migration.check-hmrc-records.foreignProperty.active")</strong>
                    </dd>
                </div>
            </dl>
        </div>
    </div>
}

@mainTemplate(
    pageTitle = messages("triggered-migration.check-hmrc-records.title"),
    backUrl = Some("#"),
    isAgent = user.isAgent,
    btaNavPartial = user.btaNavPartial
) {
    @h1(messages("triggered-migration.check-hmrc-records.heading"), id = Some("check-hmrc-records-heading"))

    @p(id = Some("check-hmrc-records-desc")){@messages("triggered-migration.check-hmrc-records.desc")}

    @govukInsetText(InsetText(
        id = Some("check-hmrc-records-inset"),
        content = Text(messages("triggered-migration.check-hmrc-records.inset"))
    ))

    @p(id = Some("check-hmrc-records-bullet-start")){@messages("triggered-migration.check-hmrc-records.bulletStart")}

    @bulletList(
        id = Some("check-hmrc-records-bullets"),
        itemMsgKeys =
            Seq(
                "triggered-migration.check-hmrc-records.bullet1",
                "triggered-migration.check-hmrc-records.bullet2"
            )
    )
    @hr()

    @h2(messages("triggered-migration.check-hmrc-records.yourActiveBusinesses.heading"), classes = "govuk-heading-l", optId = Some("your-active-businesses-heading"))

    @soleTraderSection
    @h3(messages("triggered-migration.check-hmrc-records.property.heading"), classes = "govuk-heading-m govuk-!-margin-top-5", optId = Some("property-heading"))
    @propertyBusinessSection

    @hr()

    @h2(messages("triggered-migration.check-hmrc-records.confirmRecords.heading"), classes = "govuk-heading-l", optId = Some("confirm-records-heading"))
    @p(id = Some("confirm-records-desc")){@messages("triggered-migration.check-hmrc-records.confirmRecords.text")}
    @continueButton(alternativeText = Some(messages("triggered-migration.check-hmrc-records.confirmRecords.button")))
}