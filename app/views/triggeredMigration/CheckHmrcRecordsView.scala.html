@*
 * Copyright 2025 HM Revenue & Customs
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *@

@import views.html.layouts.unifiedLayout
@import uk.gov.hmrc.govukfrontend.views.html.components._
@import views.html.components._
@import models.triggeredMigration.viewModels.CheckHmrcRecordsViewModel
@import play.twirl.api.HtmlFormat
@import models.core.NormalMode
@import enums.IncomeSourceJourney.{UkProperty, ForeignProperty, SelfEmployment}
@import enums.TriggeredMigration.TriggeredMigrationState

@this(
    mainTemplate: unifiedLayout,
    h1: h1,
    h2: h2,
    h3: h3,
    p: p,
    bulletList: bulletPointList,
    govukInsetText: GovukInsetText,
    link: link,
    continueButton: ContinueButton,
    hr: hr,
    govukNotificationBanner : GovukNotificationBanner
)


@(viewModel: CheckHmrcRecordsViewModel, isAgent: Boolean)(implicit messages: Messages, user: auth.MtdItUser[_])

@addSoleTraderBusinessURL() = @{
    if(user.isAgent()) {
        controllers.manageBusinesses.add.routes.AddBusinessNameController.showAgent(mode = NormalMode, isTriggeredMigration = true).url
    } else {
        controllers.manageBusinesses.add.routes.AddBusinessNameController.show(mode = NormalMode, isTriggeredMigration = true).url
    }
}

@ceaseSoleTraderBusinessURL(incomeSourceIdHash: String) = @{
    if(user.isAgent()) controllers.manageBusinesses.cease.routes.DeclareIncomeSourceCeasedController.showAgent(Some(incomeSourceIdHash), SelfEmployment, isTriggeredMigration = true).url
    else controllers.manageBusinesses.cease.routes.DeclareIncomeSourceCeasedController.show(Some(incomeSourceIdHash), SelfEmployment, isTriggeredMigration = true).url
}

@ceaseUKPropertyBusinessURL() = @{
    if(user.isAgent()) controllers.manageBusinesses.cease.routes.DeclareIncomeSourceCeasedController.showAgent(None, UkProperty, isTriggeredMigration = true).url
    else controllers.manageBusinesses.cease.routes.DeclareIncomeSourceCeasedController.show(None, UkProperty, isTriggeredMigration = true).url
}

@ceaseForeignPropertyBusinessURL() = @{
    if(user.isAgent()) controllers.manageBusinesses.cease.routes.DeclareIncomeSourceCeasedController.showAgent(None, ForeignProperty, isTriggeredMigration = true).url
    else controllers.manageBusinesses.cease.routes.DeclareIncomeSourceCeasedController.show(None, ForeignProperty, isTriggeredMigration = true).url
}

@soleTraderSection = {
    @h3(messages("triggered-migration.check-hmrc-records.soleTrader.heading"), classes = "govuk-heading-m", optId = Some("sole-trader-heading"))
    @p(id = Some("sole-trader-guidance")){@messages("triggered-migration.check-hmrc-records.soleTrader.guidance")}

    @for((business, index) <- viewModel.soleTraderBusinesses.zipWithIndex) {
        <div class="govuk-summary-card">
            <div class="govuk-summary-card__title-wrapper">
                <h3 class="govuk-summary-card__title" id="sole-trader-business-@index">
                @business.incomeSource.getOrElse(messages("triggered-migration.check-hmrc-records.soleTrader.unknown"))
                </h3>
                <ul class="govuk-summary-card__actions">
                    <li class="govuk-summary-card__action">
                        <a class="govuk-link" id="sole-trader-cease-link-@index" href=@ceaseSoleTraderBusinessURL(business.incomeSourceId.toHash.hash)>@messages("triggered-migration.check-hmrc-records.soleTrader.cease.link")</a>
                    </li>
                </ul>
            </div>
            <div class="govuk-summary-card__content">
                <dl class="govuk-summary-list">
                    <div class="govuk-summary-list__row">
                        <dt class="govuk-summary-list__key" id="sole-trader-business-name-@index">
                        @messages("triggered-migration.check-hmrc-records.soleTrader.businessName")
                        </dt>
                        <dd class="govuk-summary-list__value" id="sole-trader-business-name-value-@index">
                        @business.businessName.getOrElse(messages("triggered-migration.check-hmrc-records.soleTrader.unknown"))
                        </dd>
                    </div>
                    <div class="govuk-summary-list__row">
                        <dt class="govuk-summary-list__key" id="sole-trader-business-state-@index">
                        @messages("triggered-migration.check-hmrc-records.soleTrader.businessState")
                        </dt>
                        <dd class="govuk-summary-list__value" id="sole-trader-business-state-value-@index">
                            <strong class="govuk-tag govuk-tag--turquoise">@messages("triggered-migration.check-hmrc-records.soleTrader.active")</strong>
                        </dd>
                    </div>
                </dl>
            </div>
        </div>
    }
    @link(link = addSoleTraderBusinessURL, messageKey = "triggered-migration.check-hmrc-records.soleTrader.add.link", id = Some("sole-trader-add-link"))
}

@addUKPropertyStartDateURL = @{
    controllers.manageBusinesses.add.routes.AddIncomeSourceStartDateController.show(isAgent = user.isAgent(), mode = NormalMode, UkProperty, isTriggeredMigration = true).url
}

@addForeignPropertyBusinessStartDateURL = @{
    controllers.manageBusinesses.add.routes.AddIncomeSourceStartDateController.show(isAgent = user.isAgent(), mode = NormalMode, ForeignProperty, isTriggeredMigration = true).url
}

@propertyBusinessSection = @{
    (viewModel.hasActiveUkProperty, viewModel.hasActiveForeignProperty) match {
        case (true, true) => HtmlFormat.fill(Seq(ukPropertyContent, foreignPropertyContent))
        case (true, false) => HtmlFormat.fill(Seq(ukPropertyContent, addForeignPropertyLink))
        case (false, true) => HtmlFormat.fill(Seq(addUkPropertyLink, foreignPropertyContent))
        case _ => HtmlFormat.fill(Seq(noActivePropertiesContent, addUkPropertyLink, addForeignPropertyLink))
    }
}

@noActivePropertiesContent = { @p(id = Some("property-no-active-business-desc")){@messages("triggered-migration.check-hmrc-records.noActiveProperties")} }

@addUkPropertyLink() = { @p(id = Some("uk-property-add-link")){@link(link = addUKPropertyStartDateURL, messageKey = "triggered-migration.check-hmrc-records.ukProperty.add.link")}}

@ukPropertyContent = {
    <div class="govuk-summary-card">
        <div class="govuk-summary-card__title-wrapper">
            <h3 class="govuk-summary-card__title" id="uk-property-heading">
                @messages("triggered-migration.check-hmrc-records.ukProperty.heading")
            </h3>
            <ul class="govuk-summary-card__actions">
                <li class="govuk-summary-card__action">
                    <a class="govuk-link" id="uk-property-cease-link" href="@ceaseUKPropertyBusinessURL()">@messages("triggered-migration.check-hmrc-records.ukProperty.cease.link")</a>
                </li>
            </ul>
        </div>
        <div class="govuk-summary-card__content">
            <dl class="govuk-summary-list">
                <div class="govuk-summary-list__row">
                    <dt class="govuk-summary-list__key" id="uk-property-business-state">
                        @messages("triggered-migration.check-hmrc-records.ukProperty.businessState")
                    </dt>
                    <dd class="govuk-summary-list__value" id="uk-property-business-state-value">
                        <strong class="govuk-tag govuk-tag--turquoise">@messages("triggered-migration.check-hmrc-records.ukProperty.active")</strong>
                    </dd>
                </div>
            </dl>
        </div>
    </div>
}

@addForeignPropertyLink() = { @p(id = Some("foreign-property-add-link")){@link(link = addForeignPropertyBusinessStartDateURL, messageKey = "triggered-migration.check-hmrc-records.foreignProperty.add.link")}}

@foreignPropertyContent = {
    <div class="govuk-summary-card">
        <div class="govuk-summary-card__title-wrapper">
            <h3 class="govuk-summary-card__title" id="foreign-property-heading">
            @messages("triggered-migration.check-hmrc-records.foreignProperty.heading")
            </h3>
            <ul class="govuk-summary-card__actions">
                <li class="govuk-summary-card__action">
                    <a class="govuk-link" id="foreign-property-cease-link" href="@ceaseForeignPropertyBusinessURL()">@messages("triggered-migration.check-hmrc-records.foreignProperty.cease.link")</a>
                </li>
            </ul>
        </div>
        <div class="govuk-summary-card__content">
            <dl class="govuk-summary-list">
                <div class="govuk-summary-list__row">
                    <dt class="govuk-summary-list__key" id="foreign-property-business-state">
                    @messages("triggered-migration.check-hmrc-records.foreignProperty.businessState")
                    </dt>
                    <dd class="govuk-summary-list__value" id="foreign-property-business-state-value">
                        <strong class="govuk-tag govuk-tag--turquoise">@messages("triggered-migration.check-hmrc-records.foreignProperty.active")</strong>
                    </dd>
                </div>
            </dl>
        </div>
    </div>
}

@ceasedBusinessSection = {
    @h2(messages("triggered-migration.check-hmrc-records.cessation-section.heading"), classes = "govuk-heading-l", optId = Some("ceased-section-heading"))
    <p id="ceased-section-text" class="govuk-body">@messages("triggered-migration.check-hmrc-records.cessation-section.text")</p>
    <a class="govuk-link govuk-body" id="ceased-section-link" href=@controllers.manageBusinesses.cease.routes.ViewAllCeasedBusinessesController.show(isAgent)>@messages("triggered-migration.check-hmrc-records.cessation-section.text-link")</a>
}

@ceasedBannerContent(state: TriggeredMigrationState) = {
    <h3 id="ceased-banner-text-1" class="govuk-notification-banner__heading">
        @messages("triggered-migration.check-hmrc-records.cessation-banner.text1")
    </h3>
    <p id="ceased-banner-text-2" class="govuk-body">
        @messages("triggered-migration.check-hmrc-records.cessation-banner.text2")
        <a id="ceased-banner-link" class="govuk-notification-banner__link" href="@state.anchorLinkId">@messages("triggered-migration.check-hmrc-records.cessation-banner.link")</a>
    </p>
}

@ceasedBanner(state: TriggeredMigrationState) = {
    @govukNotificationBanner(NotificationBanner(
        title = HtmlContent(messages("triggered-migration.check-hmrc-records.cessation-banner.heading")),
        titleId = Some("ceased-banner-heading"),
        content = HtmlContent(ceasedBannerContent(state)),
        bannerType = Some("success")
    ))
}

@addedBannerContent(state: TriggeredMigrationState) = {
    <h3 id="added-banner-text-1" class="govuk-notification-banner__heading">
    @messages(s"triggered-migration.check-hmrc-records.add-banner.text1.${state.messageKeyValue}")
    </h3>
    <p id="added-banner-text-2" class="govuk-body">
        @messages("triggered-migration.check-hmrc-records.add-banner.text2")
        <a id="added-banner-link" class="govuk-notification-banner__link" href="@state.anchorLinkId">@messages(s"triggered-migration.check-hmrc-records.add-banner.link.${state.messageKeyValue}")</a>
    </p>
}

@addedBanner(state: TriggeredMigrationState) = {
    @govukNotificationBanner(NotificationBanner(
        title = HtmlContent(messages("triggered-migration.check-hmrc-records.add-banner.heading")),
        titleId = Some("added-banner-heading"),
        content = HtmlContent(addedBannerContent(state)),
        bannerType = Some("success")
    ))
}

@mainTemplate(
    pageTitle = messages("triggered-migration.check-hmrc-records.title"),
    backUrl = Some("#"),
    isAgent = user.isAgent,
    btaNavPartial = user.btaNavPartial
) {
    @{
        viewModel.triggeredMigrationState match {
            case Some(state) if viewModel.showCeasedBanner => ceasedBanner(state)
            case Some(state) if viewModel.showAddedBanner  => addedBanner(state)
            case _ =>
        }
    }

    @h1(messages("triggered-migration.check-hmrc-records.heading"), id = Some("check-hmrc-records-heading"))

    @p(id = Some("check-hmrc-records-desc")){@messages("triggered-migration.check-hmrc-records.desc")}

    @govukInsetText(InsetText(
        id = Some("check-hmrc-records-inset"),
        content = Text(messages("triggered-migration.check-hmrc-records.inset"))
    ))

    @p(id = Some("check-hmrc-records-bullet-start")){@messages("triggered-migration.check-hmrc-records.bulletStart")}

    @bulletList(
        id = Some("check-hmrc-records-bullets"),
        itemMsgKeys =
            Seq(
                "triggered-migration.check-hmrc-records.bullet1",
                "triggered-migration.check-hmrc-records.bullet2"
            )
    )
    @hr()

    @h2(messages("triggered-migration.check-hmrc-records.yourActiveBusinesses.heading"), classes = "govuk-heading-l", optId = Some("your-active-businesses-heading"))

    @soleTraderSection
    @h3(messages("triggered-migration.check-hmrc-records.property.heading"), classes = "govuk-heading-m govuk-!-margin-top-5", optId = Some("property-heading"))
    @propertyBusinessSection
    @hr()

    @if(viewModel.numberOfCeasedBusinesses > 0) {
        @ceasedBusinessSection
        @hr()
    }

    @h2(messages("triggered-migration.check-hmrc-records.confirmRecords.heading"), classes = "govuk-heading-l", optId = Some("confirm-records-heading"))
    @p(id = Some("confirm-records-desc")){@messages("triggered-migration.check-hmrc-records.confirmRecords.text")}
    @continueButton(alternativeText = Some(messages("triggered-migration.check-hmrc-records.confirmRecords.button")))
}