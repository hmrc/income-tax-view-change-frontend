@*
 * Copyright 2019 HM Revenue & Customs
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *@

@import implicits.ImplicitCurrencyFormatter._
@import enums._
@import models.financialTransactions.TransactionModel
@import models.calculation.CalcDisplayModel

@(calcModel: CalcDisplayModel, transactionModel: Option[TransactionModel], taxYear: Int)(implicit request: Request[_], messages: Messages, appConfig: config.FrontendAppConfig, user: auth.MtdItUser[_])

@defining(calcModel.calcDataModel.get) { breakdown =>


    @breakdown.nationalRegime.map { regime =>
        <div id="national-regime">@messages("calc-breakdown.national-regime", regime)</div>
    }

    <h3 id="income-heading" class="heading-small">@messages("calc-breakdown.income.heading")</h3>
    <div id="income-subheading" class="form-hint">@messages("calc-breakdown.income.sub-heading")</div>

    <table class="income-table">
        <tbody>

            @if(breakdown.incomeReceived.selfEmployment > 0) {
                <!-- Income from Business Profit -->
                <tr id="business-profit-section" class="no-border-bottom">
                    <td id="business-profit-label">@messages("calc-breakdown.income.business-profit")</td>
                    <td id="business-profit-data" class="summary-data">@breakdown.incomeReceived.selfEmployment.toCurrency</td>
                </tr>
            }

            @if(breakdown.incomeReceived.ukProperty > 0) {
                <!-- Income from Property -->
                <tr id="property-income-section" class="no-border-bottom">
                    <td id="property-income-label">@messages("calc-breakdown.income.property")</td>
                    <td id="property-income-data" class="summary-data">@breakdown.incomeReceived.ukProperty.toCurrency</td>
                </tr>
            }
            
            @if(breakdown.incomeReceived.ukDividends > 0) {
                <!-- Income from dividends -->
                <tr id="dividend-income-section" class="no-border-bottom">
                    <td id="dividend-income-label">@messages("calc-breakdown.income.dividends")</td>
                    <td id="dividend-income-data" class="summary-data">@breakdown.incomeReceived.ukDividends.toCurrency</td>
                </tr>
            }

            @if(breakdown.incomeReceived.bankBuildingSocietyInterest > 0) {
                <!-- Income from Savings -->
                <tr id="savings-income-section" class="no-border-bottom">
                    <td id="savings-income-label">@messages("calc-breakdown.income.savings")</td>
                    <td id="savings-income-data" class="summary-data">@breakdown.incomeReceived.bankBuildingSocietyInterest.toCurrency</td>
                </tr>
            }

            @if(breakdown.annualAllowances.personalAllowance > 0) {
                <!-- Deduction - Personal Allowance -->
                <tr id="personal-allowance-section" class="no-border-bottom">
                    <td id="personal-allowance-label">@messages("calc-breakdown.income.personal-allowance")</td>
                    <td id="personal-allowance-data" class="summary-data panel-right">@breakdown.annualAllowances.personalAllowance.toCurrency</td>
                </tr>
            }

            @if(breakdown.dividends.dividendsAllowance > 0) {
                <!-- Deduction - Dividends Allowance -->
                <tr id="dividends-allowance-section" class="no-border-bottom">
                    <td id="dividends-allowance-label">@messages("calc-breakdown.income.dividends-allowance")</td>
                    <td id="dividends-allowance-data" class="summary-data panel-right">@breakdown.dividends.dividendsAllowance.toCurrency</td>
                </tr>
            }

            @if(breakdown.savingsAndGains.savingsAllowance > 0) {
                <!-- Deduction - Savings Allowance -->
                <tr id="savings-allowance-section" class="no-border-bottom">
                    <td id="savings-allowance-label">@messages("calc-breakdown.income.savings-allowance")</td>
                    <td id="savings-allowance-data" class="summary-data panel-right">@breakdown.savingsAndGains.savingsAllowance.toCurrency</td>
                </tr>
            }

            @if(breakdown.giftOfInvestmentsAndPropertyToCharity > 0) {
                <!-- Deduction - gifts to investments and property to charity -->
                <tr id="gift-investment-property-section">
                    <td id="gift-investment-property-label">@messages("calc-breakdown.income.gift-investment-property-to-charity")</td>
                    <td id="gift-investment-property-data" class="summary-data panel-right">@breakdown.giftOfInvestmentsAndPropertyToCharity.toCurrency</td>
                </tr>
            }

            <!-- Your total taxable income -->
            <tr id="total-taxable-income-section" class="total-section no-border-bottom">
                <td id="total-taxable-income-label">@messages("calc-breakdown.income.total-taxable-income")</td>
                <td id="total-taxable-income-data" class="summary-data">@breakdown.totalTaxableIncome.toCurrency</td>
            </tr>
        </tbody>
    </table>

    <br>
    <br>

    <h3 id="calculation-heading" class="heading-small">@messages("calc-breakdown.calculation.heading")</h3>
    <div id="calculation-subheading" class="form-hint">@messages("calc-breakdown.calculation.subheading", breakdown.totalTaxableIncome.toCurrencyString)</div>

    <table class="calculation-table">
        <tbody>

            @for(band <- breakdown.payAndPensionsProfit.payAndPensionsProfitBands if band.income > 0) {
                <!-- Income tax band -->
                <tr id="income-tax-band-@{band.name}-section" class="no-border-bottom">
                    <td id="income-tax-band-@{band.name}-label">@messages("calc-breakdown.calculation.income-tax", band.income.toCurrencyString, band.rate.toString)</td>
                    <td id="income-tax-band-@{band.name}-data" class="summary-data">@band.taxAmount.toCurrency</td>
                </tr>
            }

            @for(band <- breakdown.dividends.band if band.income > 0) {
                <!-- Dividend band -->
                <tr id="dividend-tax-band-@{band.name}-section" class="no-border-bottom">
                    <td id="dividend-tax-band-@{band.name}-label">@messages("calc-breakdown.calculation.dividend", band.income.toCurrencyString, band.rate.toString)</td>
                    <td id="dividend-tax-band-@{band.name}-data" class="summary-data">@band.amount.toCurrency</td>
                </tr>
            }

            @for(band <- breakdown.savingsAndGains.bands if band.taxableIncome > 0) {
                <!-- Savings and Gains band -->
                <tr id="savings-tax-band-@{band.name}-section" class="no-border-bottom">
                    <td id="savings-tax-band-@{band.name}-label">@messages("calc-breakdown.calculation.savings", band.taxableIncome.toCurrencyString, band.taxRate.toString)</td>
                    <td id="savings-tax-band-@{band.name}-data" class="summary-data">@band.taxAmount.toCurrency</td>
                </tr>
            }

            @if(breakdown.nic.class2 > 0) {
                <!-- Class 2 National Insurance -->
                <tr id="nic-class2-section" class="no-border-bottom">
                    <td id="nic-class2-label">@messages("calc-breakdown.calculation.class-two-ni")</td>
                    <td id="nic-class2-data" class="summary-data">@breakdown.nic.class2.toCurrency</td>
                </tr>
            }

            @if(breakdown.nic.class4 > 0) {
                <!-- Class 4 National Insurance -->
                <tr id="nic-class4-section" class="no-border-bottom">
                    <td id="nic-class4-label">@messages("calc-breakdown.calculation.class-four-ni")</td>
                    <td id="nic-class4-data" class="summary-data">@breakdown.nic.class4.toCurrency</td>
                </tr>
            }

            @if(breakdown.taxReliefs > 0) {
                <!-- Tax Reliefs -->
                <tr id="tax-reliefs-section" class="no-border-bottom">
                    <td id="tax-reliefs-label">@messages("calc-breakdown.calculation.tax-relief")</td>
                    <td id="tax-reliefs-data" class="summary-data panel-right">@breakdown.taxReliefs.toCurrency</td>
                </tr>
            }

            @transactionModel.map { model =>
                <tr id="payments-to-date-section">
                    <td id="payments-to-date-label">@messages("calc-breakdown.calculation.payments-to-date")</td>
                    <td id="payments-to-date-data" class="summary-data panel-right">@model.clearedAmount.getOrElse[BigDecimal](0).toCurrency</td>
                </tr>
            }

            <tr id="your-total-section" class="total-section no-border-bottom">
                @if(calcModel.calcStatus == Estimate) {
                    <td id="your-total-estimate-label">@messages("calc-breakdown.calculation.your-total-estimate")</td>
                    <td id="your-total-estimate-data" class="summary-data">@breakdown.totalIncomeTaxNicYtd.toCurrency</td>
                } else {
                    <td>
                        <div id="your-total-tax-label">@messages("calc-breakdown.calculation.your-total-tax")</div>
                        <div id="your-total-tax-date" class="form-hint">@messages("calc-breakdown.calculation.due-date", (taxYear+1).toString)</div>
                    </td>
                    <td id="your-total-tax-data" class="summary-data">
                        @transactionModel.map { model =>
                            @model.outstandingAmount.getOrElse[BigDecimal](0).toCurrency
                        }
                    </td>
                }
            </tr>

        </tbody>
    </table>

}
