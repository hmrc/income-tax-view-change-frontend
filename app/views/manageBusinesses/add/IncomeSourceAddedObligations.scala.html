@*
 * Copyright 2023 HM Revenue & Customs
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *@

@import views.html.layouts.unifiedLayout
@import views.html.components._
@import uk.gov.hmrc.govukfrontend.views.html.components._
@import uk.gov.hmrc.govukfrontend.views.html.components.FormWithCSRF
@import views.html.helpers.injected.ErrorSummary
@import models.incomeSourceDetails.viewmodels._
@import _root_.implicits.ImplicitDateFormatterImpl
@import enums.IncomeSourceJourney.{ForeignProperty, IncomeSourceType, SelfEmployment, UkProperty}
@import java.time.LocalDate
@import exceptions.MissingFieldException

@this(
        mainTemplate: unifiedLayout,
        h1: h1,
        implicitDateFormatter: ImplicitDateFormatterImpl,
        continueButton: ContinueButton,
        formWithCSRF: FormWithCSRF,
        errorSummary: ErrorSummary,
        govukTable: GovukTable,
        govukInsetText: GovukInsetText,
)

@(sources: ObligationsViewModel, isAgent: Boolean, incomeSourceType: IncomeSourceType, businessName: Option[String] = None, currentDate: LocalDate, isBusinessHistoric: Boolean, reportingMethod: String)(implicit messages: Messages, user: auth.MtdItUser[_])

@getMessage(key: String, args: String*) = @{
    messages(s"business-added.$key", args: _*)
}
    @import implicitDateFormatter.longDate

@getPageTitle = @{

    incomeSourceType match {
        case _: SelfEmployment.type =>
            s"""${getMessage("sole-trader.head")} ${businessName.get} ${getMessage("sole-trader.base")}""".trim()

        case _: UkProperty.type =>
            s"${getMessage("uk-property.head")} " +
                    s"${getMessage("uk-property.h1")} " +
                    s"${getMessage("uk-property.base")}".trim()

        case _: ForeignProperty.type =>
            s"""${getMessage("foreign-property.h1")} ${getMessage("foreign-property.base")}"""
    }
}

@getAddIncomeSourcesCall = @{
    if(isAgent) {
        controllers.manageBusinesses.add.routes.AddIncomeSourceController.showAgent()
    } else {
        controllers.manageBusinesses.add.routes.AddIncomeSourceController.show()
    }
}

@bannerHtmlContent(head: String, h1: String, base: String) = {
    <div class="govuk-panel__body govuk-!-margin-bottom-3">
    @head
    </div>
    <h1 class="govuk-panel__title">
    @h1
    </h1>
    <div class="govuk-panel__body">
    @base
    </div>
}

@getBannerContent() = @{
    incomeSourceType match {
        case _: SelfEmployment.type =>
            bannerHtmlContent(getMessage("sole-trader.head"), businessName.get, getMessage("sole-trader.base"))
        case _: UkProperty.type =>
            bannerHtmlContent(getMessage("uk-property.head"), getMessage("uk-property.h1"), getMessage("uk-property.base"))
        case _: ForeignProperty.type =>
            bannerHtmlContent(getMessage("foreign-property.head"),
                getMessage("foreign-property.h1"),
                getMessage("foreign-property.base"))
    }
}

@getManageUrl = @{
    controllers.manageBusinesses.routes.ManageYourBusinessesController.show(isAgent).url
}

@getNextUpdatesUrl = @{
    if(isAgent) {
        controllers.routes.NextUpdatesController.showAgent.url
    } else {
        controllers.routes.NextUpdatesController.show().url
    }
}



@getReportingFrequencyUrl = @{
    controllers.manageBusinesses.add.routes.IncomeSourceReportingMethodController.show(isAgent, incomeSourceType).url
}

@getSoftwareUrl = @{
    "https://www.gov.uk/guidance/find-software-thats-compatible-with-making-tax-digital-for-income-tax"
}
@getOverdueObligationsMessage(overdueObligationsComponents: OverdueObligationsMessageComponents) = @{
    messages(s"business-added.${overdueObligationsComponents.messageKey}", overdueObligationsComponents.args: _*)
}

@getQuarterlyUpdateDate = @{
 sources.getFirstUpcomingQuarterlyDate(currentDate)
}

@getFinalDecDate = @{
    sources.getFinalDeclarationDate(currentDate)
}

@mainTemplate(pageTitle = getPageTitle,
    isAgent = isAgent,
    btaNavPartial = user.btaNavPartial) {

    @formWithCSRF(action = getAddIncomeSourcesCall) {

        <div class="govuk-panel govuk-panel--confirmation" id="banner">
        @getBannerContent()
        </div>

      @if(sources.getOverdueObligationsMessageComponents(currentDate, isBusinessHistoric).messageKey.nonEmpty) {
        @if(sources.getOverdueObligationsMessageComponents(currentDate, isBusinessHistoric).messageKey != "hybrid") {
          @govukInsetText(InsetText(id = Some("warning-inset"), content = HtmlContent(getOverdueObligationsMessage(sources.getOverdueObligationsMessageComponents(currentDate, isBusinessHistoric)))))
        } else {
          @govukInsetText(InsetText(id = Some("annual-warning-inset"), content = HtmlContent(getOverdueObligationsMessage(sources.copy(quarterlyObligationsDates = Nil).getOverdueObligationsMessageComponents(currentDate, isBusinessHistoric)))))
          @govukInsetText(InsetText(id = Some("quarterly-warning-inset"), content = HtmlContent(getOverdueObligationsMessage(sources.copy(finalDeclarationDates = Nil).getOverdueObligationsMessageComponents(currentDate, isBusinessHistoric)))))
        }

        <div class="govuk-link govuk-body" id="view-overdue-upcoming-updates">
          <a href=@getNextUpdatesUrl>@getMessage("obligation.view-overdue-upcoming-updates.text")</a>
        </div>
      }

        <h2 class="govuk-label-wrapper">
            <label class="govuk-heading-m govuk-!-margin-top-8" id="deadlines">
            @getMessage("deadlines")
            </label>
        </h2>

            <ul class="govuk-list govuk-list--bullet">
                <li id="quarterly-list">
                @getQuarterlyUpdateDate.map { quarterlyUpdate =>
                        @getMessage("next-quarterly-obligation-text-1", quarterlyUpdate.inboundCorrespondenceFrom.getYear.toString, quarterlyUpdate.inboundCorrespondenceTo.getYear.toString)
                        <span class="govuk-!-font-weight-bold">
                        @getMessage("next-quarterly-obligation-date", quarterlyUpdate.inboundCorrespondenceDue.toLongDate)
                        </span>
                        @getMessage("next-quarterly-obligation-text-2", quarterlyUpdate.inboundCorrespondenceFrom.toLongDate, quarterlyUpdate.inboundCorrespondenceTo.toLongDate)
                    }
                </li>

                <li id="obligations-list">
                @getFinalDecDate.map { finalDecDate =>
                    @getMessage("final-dec-text", finalDecDate.inboundCorrespondenceFrom.getYear.toString, finalDecDate.inboundCorrespondenceTo.getYear.toString)
                    <span class="govuk-!-font-weight-bold">
                    @getMessage("final-dec-date", finalDecDate.inboundCorrespondenceDue.toLongDate)
                </span>
                }
                </li>
            </ul>

            <p class="govuk-body" id="final-declaration">
                @getFinalDecDate.map { finalDecDate =>
                    @getMessage("final-dec-text", finalDecDate.inboundCorrespondenceFrom.getYear.toString, finalDecDate.inboundCorrespondenceTo.getYear.toString)
                    <span class="govuk-!-font-weight-bold">
                    @getMessage("final-dec-date", finalDecDate.inboundCorrespondenceDue.toLongDate)
                </span>
                }
            </p>


        <div class="govuk-link govuk-body" id="view-overdue-upcoming-updates">
            <a href=@getNextUpdatesUrl>@getMessage("obligation.view-overdue-upcoming-updates.text")</a>
        </div>

        <div class="govuk-link govuk-body" id="view-all-businesses-link">
            <a href=@getManageUrl>@getMessage("view-all-businesses")</a>
        </div>

        @if(reportingMethod == "Hybrid" || reportingMethod == "Quarterly") {
            <div class="govuk-body govuk-!-margin-top-8" id="change-frequency-hybrid">
                @getMessage("quarterly-opt-out-hybrid-text-1")
                <a href=@getReportingFrequencyUrl>@getMessage("quarterly-opt-out-hybrid-link")</a>
                @getMessage("quarterly-opt-out-hybrid-text-2")
            </div>
        }

        @if(reportingMethod == "Annual"){
            <div class="govuk-body govuk-!-margin-top-8" id="change-frequency-hybrid">
            @getMessage("quarterly-opt-out-text-1")
            <a href=@getReportingFrequencyUrl>@getMessage("quarterly-opt-out-link")</a>
            @getMessage("quarterly-opt-out-text-2")
            </div>
        }

        @if(reportingMethod == "Hybrid" | reportingMethod == "Quarterly"){
            <h2 class="govuk-heading-m govuk-!-margin-top-8">@getMessage("submit-software-text")</h2>

            <div class="govuk-body">
                <p>@getMessage("submit-software-quarterly-text")
                    <a href=@getSoftwareUrl>@getMessage("submit-software-quarterly-link")</a>
                </p>
            </div>
        }


        @if(reportingMethod == "Annual"){
            <h2 class="govuk-heading-m govuk-!-margin-top-8">@getMessage("submit-tax-return")</h2>

            <div class="govuk-body">
                <p>@getMessage("submit-tax-return-text")
                    <a href=@getSoftwareUrl>@getMessage("submit-tax-return-link")</a>
                </p>
            </div>
        }


        <div class="govuk-body govuk-!-margin-top-8" id="change-frequency-hybrid">
            @getMessage("quarterly-opt-out-hybrid-text-1")
            <a href=@getReportingFrequencyUrl>@getMessage("quarterly-opt-out-hybrid-link")</a>
            @getMessage("quarterly-opt-out-hybrid-text-2")
        </div>

        @if(!sources.isHybridReporting){
            <h2 class="govuk-heading-m govuk-!-margin-top-8">@getMessage("submit-software-text")</h2>

            <div class="govuk-body">
                <p>@getMessage("submit-software-quarterly-text")
                    <a href=@getSoftwareUrl>@getMessage("submit-software-quarterly-link")</a>
                </p>
            </div>
        }


        @if(sources.isHybridReporting){
            <h2 class="govuk-heading-m govuk-!-margin-top-8">@getMessage("submit-tax-return")</h2>

            <div class="govuk-body">
                <p>@getMessage("submit-tax-return-text")
                    <a href=@getSoftwareUrl>@getMessage("submit-tax-return-link")</a>
                </p>
            </div>
        }


    }
}