@*
 * Copyright 2023 HM Revenue & Customs
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *@

@import _root_.implicits.ImplicitCurrencyFormatter._
@import _root_.implicits.ImplicitDateFormatterImpl
@import models.liabilitycalculation.viewmodels.TaxYearSummaryViewModel
@import services.DateServiceInterface
@import uk.gov.hmrc.govukfrontend.views.html.components._
@import views.html.components._
@import views.html.layouts.unifiedLayout
@import views.html.partials.taxYearSummary._
@import views.html.partials.{taxYearSummaryBreakdownPartial, taxYearSummaryTabsPartial}


@this(
        mainTemplate: unifiedLayout,
        implicitDateFormatter: ImplicitDateFormatterImpl,
        breakdownPartial: taxYearSummaryBreakdownPartial,
        h1WithCaption: h1WithCaption,
        h2: h2,
        h3WithHtml: h3WithHtml,
        p: p,
        link: link,
        govukInsetText: GovukInsetText,
        govukTable: GovukTable,
        taxYearSummaryTabsPartial: taxYearSummaryTabsPartial,
        taxCalculationContent: TaxCalculationContent,
        getClaimToAdjustPoaSection: GetClaimToAdjustPoaSection,
        forecastContentTable: ForecastContentTable,
        paymentsContent: PaymentsContent,
        updatesContent: UpdatesContent,
        forecastContent: ForecastContent
)

@(taxYear: Int, viewModel: TaxYearSummaryViewModel, backUrl: String, isAgent: Boolean = false, origin: Option[String] = None, ctaLink: String
)(implicit request: Request[_], dateService: DateServiceInterface, messages: Messages, user: auth.MtdItUser[_])
@import implicitDateFormatter._

@mainTemplate(pageTitle = messages("tax-year-summary.heading"), backUrl = Some(backUrl), isAgent = isAgent,
    btaNavPartial = user.btaNavPartial, useFallbackBackLink = true) {
    @h1WithCaption(
        heading = messages("tax-year-summary.heading"),
        captionMsg = messages("tax-year-summary.heading-secondary", (taxYear - 1).toString, taxYear.toString),
        headingId = Some("heading")
    )

    @viewModel.calculationSummary.map { model =>
        @if(!model.crystallised && !model.messages.isDefined) {
            @govukInsetText(InsetText(content = HtmlContent(
                p(id = Some("calc-date-info"))(content = Html(
                    messages(if(isAgent) "tax-year-summary.agent.calc-from-last-time" else "tax-year-summary.calc-from-last-time",
                        model.timestamp.map(_.toLongDate).get))
                )
            )))
        }
        @if(!model.errorPresent()) {
            <dl class="govuk-summary-list">
                <div class="govuk-summary-list__row">
                    <dt class="govuk-summary-list__key dt-cell-width">
                    @messages("tax-year-summary.calculation-date")
                    </dt>
                    <dd class="govuk-summary-list__value--numeric govuk-!-text-align-right govuk-!-margin-0">
                        <span id="calculation-date">@{
                            model.timestamp.map(_.toLongDate)
                        }</span>
                    </dd>
                </div>
                <div class="govuk-summary-list__row">
                    <dt class="govuk-summary-list__key dt-cell-width">
                    @if(model.crystallised) {
                        @messages("tax-year-summary.total-due")
                    } else {
                        @{
                            if(!model.periodFrom.isEmpty && !model.periodTo.isEmpty) {
                                val calculationDateFrom = implicitDateFormatter.longDate(model.periodFrom.get).toLongDate
                                val calculationDateTo = implicitDateFormatter.longDate(model.periodTo.get).toLongDate
                                messages("tax-year-summary.tax-calculation.date", calculationDateFrom, calculationDateTo)
                            }
                        }
                    }
                    </dt>
                    <dd class="govuk-summary-list__value--numeric govuk-!-text-align-right">
                    @{
                        model.taxDue.toCurrencyString
                    }
                    </dd>
                </div>
                @if(viewModel.showForecastData && viewModel.calculationSummary.isDefined) {
                    <div id="forecast_total" class="govuk-summary-list__row">
                        <dt class="govuk-summary-list__key dt-cell-width">
                        @messages("tax-year-summary.forecast_total_title", s"${taxYear - 1}", s"$taxYear")
                        </dt>
                        <dd class="govuk-summary-list__value--numeric govuk-!-text-align-right">
                        @model.forecastIncomeTaxAndNics.get.toCurrencyString
                        </dd>
                    </div>
                }
            </dl>
        }
    }

    @{
        viewModel.ctaViewModel.claimToAdjustTaxYear match {
            case Some(value) =>
                govukInsetText(
                    InsetText(
                        content = HtmlContent(
                            p(id = Some("claim-to-adjust-poa"))(Html(messages("tax-year-summary.adjust-poa-paragraph"))).toString +
                                    p(id = Some("claim-to-adjust-poa-link"))
                                            (
                                                Html(
                                                    link(
                                                        link = ctaLink,
                                                        messageKey = messages("tax-year-summary.adjust-poa", value.startYear.toString, value.endYear.toString),
                                                        id = Some("adjust-poa-link")
                                                    ).toString
                                                )
                                            ).toString
                        )
                    )
                )
            case None => Html("")
        }
    }

    @taxYearSummaryTabsPartial(viewModel.showForecastData, viewModel.showUpdates, taxCalculationContent(taxYear, viewModel, isAgent), paymentsContent(viewModel, taxYear, isAgent, origin), forecastContent(viewModel, taxYear), updatesContent(viewModel))
}

