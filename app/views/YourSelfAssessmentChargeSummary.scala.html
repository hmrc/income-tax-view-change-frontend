@*
 * Copyright 2023 HM Revenue & Customs
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *@

@import _root_.implicits.ImplicitCurrencyFormatter.CurrencyFormatter
@import _root_.implicits.ImplicitDateFormatterImpl
@import models.chargeSummary.ChargeSummaryViewModel
@import services.DateServiceInterface
@import uk.gov.hmrc.govukfrontend.views.html.components._
@import views.html.components._
@import views.html.layouts.unifiedLayout
@import uk.gov.hmrc.hmrcfrontend.views.html.components.HmrcPageHeading
@import uk.gov.hmrc.hmrcfrontend.views.viewmodels.pageheading.PageHeading
@import views.html.partials.yourSelfAssessmentCharges.PaymentHistoryTable
@import views.html.partials.yourSelfAssessmentCharges.InterestOnYourChargeTable
@import views.html.partials.yourSelfAssessmentCharges.InterestOnYourChargeSection
@import views.helpers.ChargeNameLangHelper
@import views.html.partials.yourSelfAssessmentCharges.ChargeDetails
@import views.html.partials.yourSelfAssessmentCharges.WhatIsPaymentOnAccount
@import views.html.partials.chargeSummary.ChargeSummaryHasDunningLocksOrLpiWithDunningLock
@import views.html.partials.paymentAllocations.PaymentAllocationsCreditAmount
@import views.html.partials.paymentAllocations.PaymentAllocationsForLpi
@import views.html.partials.paymentAllocations.PaymentAllocationsForNonLpi
@import models.paymentAllocationCharges.PaymentAllocationViewModel
@import _root_.implicits.HtmlFormatter.EmspString
@import java.time.LocalDate

@this(
        mainTemplate: unifiedLayout,
        appConfig: config.FrontendAppConfig,
        implicitDateFormatter: ImplicitDateFormatterImpl,
        h1WithCaption: h1WithCaption,
        govukTable: GovukTable,
        p: p,
        link: link,
        numberList: numberList,
        bulletPointList: bulletPointList,
        h2: h2,
        govukWarningText: GovukWarningText,
        govukInsetText: GovukInsetText,
        govukDetails : GovukDetails,
        chargeDetails: ChargeDetails,
        hmrcPageHeading: HmrcPageHeading,
        interestOnYourChargeSection: InterestOnYourChargeSection,
        interestOnYourChargeTable: InterestOnYourChargeTable,
        paymentHistoryTable: PaymentHistoryTable,
        chargeSummaryHasDunningLocksOrLpiWithDunningLock: ChargeSummaryHasDunningLocksOrLpiWithDunningLock,
        whatIsPaymentOnAccount: WhatIsPaymentOnAccount,
        paymentAllocationsForNonLpi: PaymentAllocationsForNonLpi,
        paymentAllocationsForLpi: PaymentAllocationsForLpi,
        paymentAllocationsCreditAmount: PaymentAllocationsCreditAmount
)

@(
    viewModel: ChargeSummaryViewModel,
    paymentAllocations: Option[PaymentAllocationViewModel] = None,
    whatYouOweUrl: String,
    saChargesUrl: String,
    yourSelfAssessmentChargesFS: Boolean
)(
    implicit request: Request[_],
    messages: Messages,
    appConfig: config.FrontendAppConfig,
    dateService: DateServiceInterface
)

@import implicitDateFormatter.longDate

@getMessage(key: String, args: String*) = @{
    messages(s"yourSelfAssessmentChargeSummary.$key", args: _*)
}

@pageHeading = @{ ChargeNameLangHelper.getHeading(viewModel.chargeItem) }

@WYOorYSACLinkContent = {
    @if(yourSelfAssessmentChargesFS) {
        @p() {
            @if(viewModel.isAgent) {
                @messages("yourSelfAssessmentChargeSummary.selfAssessmentCharges.linkText-agent.part1")
                @link(id = Some("SAChargesAgentLink"), link = saChargesUrl, messageKey = "yourSelfAssessmentChargeSummary.selfAssessmentCharges.linkText-agent.part2")
                @messages("chargeSummary.selfAssessmentCharges.text-agent")
            } else {
                @messages("yourSelfAssessmentChargeSummary.selfAssessmentCharges.linkText.part1")
                @link(id = Some("SAChargesLink"), link = saChargesUrl, messageKey = "yourSelfAssessmentChargeSummary.selfAssessmentCharges.linkText.part2")
                @messages("chargeSummary.selfAssessmentCharges.text")
            }
        }
    } else {
        @p() {
            @if(viewModel.isAgent) {
                @messages("chargeSummary.whatYouOwe.textOne-agent"),
                @link(id = Some("what-you-owe-link-agent"), link = whatYouOweUrl, messageKey = "chargeSummary.whatYouOwe.linkText-agent")
                @messages("chargeSummary.whatYouOwe.textTwo-agent")
            } else {
                @messages("chargeSummary.whatYouOwe.textOne")
                @link(id = Some("what-you-owe-link"), link = whatYouOweUrl, messageKey = "chargeSummary.whatYouOwe.linkText")
                @messages("chargeSummary.whatYouOwe.textTwo")
            }
        }
    }
}

@mainTemplate(
    pageTitle = pageHeading,
    backUrl = Some(viewModel.backUrl),
    isAgent = viewModel.isAgent,
    btaNavPartial = viewModel.btaNavPartial,
    gatewayPage = viewModel.gatewayPage) {

    @if(viewModel.hasDunningLocks || viewModel.chargeItem.hasLpiWithDunningLock) {
        @chargeSummaryHasDunningLocksOrLpiWithDunningLock(viewModel.chargeItem, viewModel.dueDate, viewModel.latePaymentInterestCharge, appConfig)
    }

    @hmrcPageHeading(PageHeading(
        text = pageHeading,
        headingClasses = Some("govuk-heading-xl"),
        section = Some(getMessage("tax-year", viewModel.taxYearFrom.toString, viewModel.taxYearTo.toString)),
        captionClasses = Some("govuk-caption-xl")
    ))

  @if(!viewModel.chargeItem.isPaid && !viewModel.chargeItem.isCredit) {
      <h2 class="govuk-heading-m" id="charge-amount-heading"> @{
          s"${
              getMessage(
                  if(viewModel.chargeItem.isCreditDrilldownPage) "creditAmount" else
                  if(viewModel.chargeItem.isCodingOut) "toBeCollected" else
                  if(viewModel.chargeItem.isOverdue()) "overDueCharge"
                  else "charge"
              )
          }\t${viewModel.chargeItem.outstandingAmount.toCurrencyString}"
      }</h2>

      @if(!viewModel.chargeItem.isCodingOut) {
          @p(id = Some("due-date-text")) {
              <b>@getMessage("due", viewModel.chargeItem.getDueDate.toLongDate)</b>
          }
      }

      @chargeDetails(
          viewModel.chargeItem,
          viewModel.taxYearFrom.toString,
          viewModel.taxYearTo.toString,
          viewModel.isAgent,
          viewModel.LSPUrl,
          viewModel.LPPUrl,
          if (yourSelfAssessmentChargesFS) saChargesUrl else whatYouOweUrl
      )

      @WYOorYSACLinkContent
  }
    @if(viewModel.chargeItem.isCreditDrilldownPage) {
        <h2 class="govuk-heading-m" id="charge-amount-heading"> @{
            s"${getMessage("creditAmount")
            }\t${viewModel.chargeItem.originalAmount.abs.toCurrencyString}"
        }</h2>
        @p(id = Some("credit-created-text")) {
            <b>@getMessage("creditCreated", viewModel.chargeItem.documentDate.toLongDate)</b>
        }

        @chargeDetails(
            viewModel.chargeItem,
            viewModel.taxYearFrom.toString,
            viewModel.taxYearTo.toString,
            viewModel.isAgent,
            viewModel.LSPUrl,
            viewModel.LPPUrl,
            if (yourSelfAssessmentChargesFS) saChargesUrl else whatYouOweUrl
        )

        @WYOorYSACLinkContent
    }
    @if(viewModel.chargeItem.isPaid && viewModel.chargeItem.isPoaDebit) {
    <h1 class="govuk-heading-m" id="charge-amount-heading"> @{
        s"${ getMessage("youOwe")
        }\t${viewModel.chargeItem.outstandingAmount.toCurrencyString}".toEmsp
        }</h1>

     @whatIsPaymentOnAccount()

    @WYOorYSACLinkContent
 }


    @if(viewModel.poaExtraChargeLink.isDefined){
        @p(id = Some("poa-extra-charge-content")) {
            @messages("chargeSummary.extraCharge.text1")
            @link(id = Some("poa-extra-charge-link"), link = viewModel.poaExtraChargeLink.getOrElse(""), messageKey = "chargeSummary.extraCharge.linkText")
            @messages("chargeSummary.extraCharge.text2")
        }
    }

    @if(viewModel.chargeItem.isAccruingInterest) {

        @interestOnYourChargeSection(viewModel.chargeItem)

        @interestOnYourChargeTable(viewModel)
    }

    @if(viewModel.chargeHistoryEnabledOrPaymentAllocationWithNoIsBalancingChargeZeroAndIsNotCredit) {
        @paymentHistoryTable(viewModel)
    }
    @if(viewModel.isCredit && paymentAllocations.isDefined) {

        @h2(getMessage("allocation.heading"))

        <table class="govuk-table" id="payment-allocation-table">
            <caption class="govuk-table__caption heading-large govuk-visually-hidden">@messages("paymentAllocation.tableSection.heading")</caption>
            <thead class="govuk-table__head">
                <tr class="govuk-table__row">
                    <th scope="col" class="govuk-table__header">@messages("paymentAllocation.tableHead.allocated-date")</th>
                    <th scope="col" class="govuk-table__header">@messages("paymentAllocation.tableHead.description")</th>
                    <th scope="col" class="govuk-table__header">@messages("paymentAllocation.tableHead.tax-year")</th>
                    <th scope="col" class="govuk-table__header govuk-table__header--numeric">@messages("paymentAllocation.tableHead.amount")</th>
                </tr>
            </thead>
            @if(paymentAllocations.get.isLpiPayment) {
            @paymentAllocationsForLpi(paymentAllocations.get, viewModel.isAgent)
            } else {
            @paymentAllocationsForNonLpi(paymentAllocations.get, viewModel.isAgent)
            }
            @paymentAllocationsCreditAmount(paymentAllocations.get.outstandingAmount, paymentAllocations.get.dueDate, true, viewModel.isAgent)
        </table>
    }
}
