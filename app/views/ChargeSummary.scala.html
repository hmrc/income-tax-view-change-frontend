@*
 * Copyright 2023 HM Revenue & Customs
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *@

@import _root_.implicits.ImplicitCurrencyFormatter.CurrencyFormatter
@import _root_.implicits.ImplicitDateFormatterImpl
@import models.chargeSummary.ChargeSummaryViewModel
@import models.financialDetails.{Accepted, Cancelled, PoaOneReconciliationCredit}
@import services.DateServiceInterface
@import uk.gov.hmrc.govukfrontend.views.html.components._
@import uk.gov.hmrc.govukfrontend.views.viewmodels.warningtext.WarningText
@import views.html.components._
@import views.html.layouts.unifiedLayout
@import views.html.partials.chargeSummary._
@import models.repaymentHistory.RepaymentHistoryUtils
@import _root_.implicits.HtmlFormatter.NbspString
@import java.time.LocalDate
@import models.chargeSummary.PaymentHistoryAllocations
@import models.financialDetails.FinancialDetailsModel
@import exceptions.MissingFieldException
@import models.financialDetails.MfaDebitCharge
@import uk.gov.hmrc.hmrcfrontend.views.html.components.HmrcPageHeading
@import uk.gov.hmrc.hmrcfrontend.views.viewmodels.pageheading.PageHeading

@this(
    mainTemplate: unifiedLayout,
    appConfig: config.FrontendAppConfig,
    implicitDateFormatter: ImplicitDateFormatterImpl,
    p: p,
    link: link,
    govukWarningText : GovukWarningText,
    chargeSummaryLpiCharge: ChargeSummaryLpiCharge,
    chargeSummaryPaymentAllocation: ChargeSummaryPaymentAllocation,
    chargeSummaryHasPaymentBreakdown: ChargeSummaryHasPaymentBreakdown,
    chargeSummaryCodingOut: ChargeSummaryCodingOut,
    chargeSummaryHasDunningLocksOrLpiWithDunningLock: ChargeSummaryHasDunningLocksOrLpiWithDunningLock,
    chargeSummaryNotCodingOutAndNotPayeSelfAssessment: ChargeSummaryNotCodingOutAndNotPayeSelfAssessment,
    chargeSummaryPaymentAllocationTable: ChargeSummaryPaymentAllocationTable,
    getInterestRatesLink: GetInterestRatesLink,
    getExplanationContent: GetExplanationContent,
    checkPayeCodePara: CheckPayeCodePara,
    codingOutMessage: CodingOutMessage,
    codingOutMessageInset: CodingOutMessageInset,
    codingOutCancelledMessageInset: CodingOutCancelledMessageInset,
    viewWhatYouOweText: ViewWhatYouOweText,
    hmrcPageHeading: HmrcPageHeading,
    paymentHistoryTable: PaymentHistoryTable,
    poaExtraAmountExplanation: PoaExtraAmountExplanation,
    govukInsetText : GovukInsetText
)

@(
    viewModel: ChargeSummaryViewModel
)(
    implicit request : Request[_],
    messages: Messages,
    appConfig: config.FrontendAppConfig,
    dateService: DateServiceInterface
)

@import implicitDateFormatter.longDate

@mainTemplate(
    pageTitle = messages(viewModel.pageTitle),
    backUrl = Some(viewModel.backUrl),
    isAgent = viewModel.isAgent,
    btaNavPartial = viewModel.btaNavPartial,
    gatewayPage = viewModel.gatewayPage
) {

    @if(viewModel.hasDunningLocks || viewModel.chargeItem.hasLpiWithDunningLock) {
        @chargeSummaryHasDunningLocksOrLpiWithDunningLock(
            viewModel.chargeItem,
            viewModel.dueDate,
            viewModel.latePaymentInterestCharge,
            appConfig
        )
    }

    @hmrcPageHeading(PageHeading(
        text = messages(viewModel.pageTitle),
        headingClasses = Some("govuk-heading-xl"),
        section = Some(messages("paymentDue.tax-year", viewModel.taxYearFrom, viewModel.taxYearTo)),
        captionClasses = Some("govuk-caption-xl")
    ))

    @if(viewModel.chargeItem.isPoaReconciliationDebit && !viewModel.latePaymentInterestCharge) {
        @govukWarningText(WarningText(
            content = Text(messages("chargeSummary.reviewAndReconcilePoa.warning"))
        ))
    }

    @getExplanationContent(viewModel)

    @if(viewModel.chargeItem.subTransactionType.contains(Accepted)) {
        @checkPayeCodePara(viewModel.currentTaxYearEnd, viewModel.taxYearFrom, viewModel.taxYearTo)
        @govukInsetText(InsetText(
            id = Some("coding-out-wrapper"),
            content = HtmlContent(codingOutMessageInset())
        ))
        @codingOutMessage(viewModel.taxYearFrom, viewModel.taxYearTo)
    }

    @if(viewModel.chargeItem.subTransactionType.contains(Cancelled)) {
        @checkPayeCodePara(viewModel.currentTaxYearEnd, viewModel.taxYearFrom, viewModel.taxYearTo)
        @govukInsetText(InsetText(
            id = Some("cancelled-coding-out"),
            content = HtmlContent(codingOutCancelledMessageInset())
        ))
        @codingOutMessage(viewModel.taxYearFrom, viewModel.taxYearTo)
    }

    @if(viewModel.codingOutEnabledAndIsClass2NicWithNoIsPayeSelfAssessment) {
        @p(id = Some("nic2TaxYear")){
            @messages("chargeSummary.nic2TaxYear", viewModel.taxYearFrom, viewModel.taxYearTo)
        }
    }

    @if(!viewModel.chargeItem.subTransactionType.contains(Accepted)) {
        @chargeSummaryNotCodingOutAndNotPayeSelfAssessment(
            viewModel.chargeItem,
            viewModel.latePaymentInterestCharge,
            viewModel.taxYearFromCodingOut,
            viewModel.taxYearToCodingOut,
            appConfig)
    }

    @if(viewModel.chargeItem.subTransactionType.contains(Accepted)) {
        @chargeSummaryCodingOut(
            viewModel.chargeItem,
            viewModel.taxYearFromCodingOut,
            viewModel.taxYearToCodingOut,
            viewModel.latePaymentInterestCharge
        )
    }

    @if(viewModel.hasPaymentBreakdown && !viewModel.isBalancingChargeZero) {
        @chargeSummaryHasPaymentBreakdown(
            viewModel.chargeItem,
            viewModel.paymentBreakdown,
            viewModel.latePaymentInterestCharge,
            chargeSummaryLpiCharge,
            viewModel.isAgent
        )
    }

    @if(viewModel.poaExtraChargeLink.isDefined) {
        @poaExtraAmountExplanation(viewModel.poaExtraChargeLink)
    }

    @if(viewModel.latePaymentInterestCharge) {
        @getInterestRatesLink()
    }

    @if(!viewModel.isCredit) {
        @viewWhatYouOweText(
            viewModel.isAgent,
            viewModel.hasInterestLocks,
            viewModel.hasAccruedInterest,
            viewModel.whatYouOweUrl
        )
    }

    @if(viewModel.chargeHistoryEnabledOrPaymentAllocationWithNoIsBalancingChargeZeroAndIsNotCredit) {
        @paymentHistoryTable(viewModel)
    }

    @if(viewModel.chargeItem.isPoaReconciliationCredit) {
        @chargeSummaryPaymentAllocationTable(
            viewModel.chargeItem,
            viewModel.poaChargeUrl,
            messages(viewModel.poaChargeLinkTextMessageKey)
        )
    }
}
