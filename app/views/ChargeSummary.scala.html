@*
 * Copyright 2023 HM Revenue & Customs
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *@

@import _root_.implicits.ImplicitCurrencyFormatter.CurrencyFormatter
@import _root_.implicits.ImplicitDateFormatterImpl
@import models.chargeSummary.ChargeSummaryViewModel
@import models.financialDetails.{Accepted, Cancelled, PoaOneReconciliationCredit}
@import services.DateServiceInterface
@import uk.gov.hmrc.govukfrontend.views.html.components._
@import uk.gov.hmrc.govukfrontend.views.viewmodels.warningtext.WarningText
@import views.html.components._
@import views.html.layouts.unifiedLayout
@import views.html.partials.chargeSummary._
@import models.repaymentHistory.RepaymentHistoryUtils
@import _root_.implicits.HtmlFormatter.NbspString
@import java.time.LocalDate
@import models.chargeSummary.PaymentHistoryAllocations
@import models.financialDetails.FinancialDetailsModel
@import exceptions.MissingFieldException
@import models.financialDetails.MfaDebitCharge
@import uk.gov.hmrc.hmrcfrontend.views.html.components.HmrcPageHeading
@import uk.gov.hmrc.hmrcfrontend.views.viewmodels.pageheading.PageHeading

@this(
    mainTemplate: unifiedLayout,
    appConfig: config.FrontendAppConfig,
    implicitDateFormatter: ImplicitDateFormatterImpl,
    p: p,
    link: link,
    govukWarningText : GovukWarningText,
    govukTable: GovukTable,
    chargeSummaryLpiCharge: ChargeSummaryLpiCharge,
    chargeSummaryPaymentAllocation: ChargeSummaryPaymentAllocation,
    chargeSummaryHasPaymentBreakdown: ChargeSummaryHasPaymentBreakdown,
    chargeSummaryCodingOut: ChargeSummaryCodingOut,
    chargeSummaryHasDunningLocksOrLpiWithDunningLock: ChargeSummaryHasDunningLocksOrLpiWithDunningLock,
    chargeSummaryNotCodingOutAndNotPayeSelfAssessment: ChargeSummaryNotCodingOutAndNotPayeSelfAssessment,
    chargeSummaryPaymentAllocationTable: ChargeSummaryPaymentAllocationTable,
    getInterestRatesLink: GetInterestRatesLink,
    reviewAndReconcileCreditMessage: ReviewAndReconcileCreditMessage,
    getExplanationContent: GetExplanationContent,
    checkPayeCodePara: CheckPayeCodePara,
    codingOutMessage: CodingOutMessage,
    codingOutMessageInset: CodingOutMessageInset,
    codingOutCancelledMessageInset: CodingOutCancelledMessageInset,
    chargeHistoryHeading: ChargeHistoryHeading,
    getCreationDate: GetCreationDate,
    viewWhatYouOweText: ViewWhatYouOweText,
    hmrcPageHeading: HmrcPageHeading,
    latePaymentInterestChargeMessage: LatePaymentInterestChargeMessage,
    govukInsetText : GovukInsetText
)

@(
    viewModel: ChargeSummaryViewModel
)(
    implicit request : Request[_],
    messages: Messages,
    appConfig: config.FrontendAppConfig,
    dateService: DateServiceInterface
)

@import implicitDateFormatter.longDate

@mainTemplate(
    pageTitle = messages(viewModel.pageTitle),
    backUrl = Some(viewModel.backUrl),
    isAgent = viewModel.isAgent,
    btaNavPartial = viewModel.btaNavPartial,
    gatewayPage = viewModel.gatewayPage
) {

    @if(viewModel.hasDunningLocks || viewModel.chargeItem.hasLpiWithDunningLock) {
        @chargeSummaryHasDunningLocksOrLpiWithDunningLock(
            viewModel.chargeItem,
            viewModel.dueDate,
            viewModel.latePaymentInterestCharge,
            appConfig
        )
    }

    @hmrcPageHeading(PageHeading(
        text = messages(viewModel.pageTitle),
        headingClasses = Some("govuk-heading-xl"),
        section = Some(messages("paymentDue.tax-year", viewModel.taxYearFrom.toString, viewModel.taxYearTo.toString)),
        captionClasses = Some("govuk-caption-xl")
    ))

    @if(viewModel.chargeItem.isPoaReconciliationDebit && !viewModel.latePaymentInterestCharge) {
        @govukWarningText(WarningText(content = Text(messages("chargeSummary.reviewAndReconcilePoa.warning"))))
    }

    @getExplanationContent(viewModel)

    @if(viewModel.chargeItem.subTransactionType.contains(Accepted)){
        @checkPayeCodePara(viewModel)
        @govukInsetText(InsetText(id = Some("coding-out-wrapper"), content = HtmlContent(codingOutMessageInset())))
        @codingOutMessage(viewModel)
    }

    @if(viewModel.chargeItem.subTransactionType.contains(Cancelled)){
        @checkPayeCodePara(viewModel)
        @govukInsetText(InsetText(id = Some("cancelled-coding-out"), content = HtmlContent(codingOutCancelledMessageInset(viewModel))))
        @codingOutMessage(viewModel)
    }

    @if(viewModel.codingOutEnabledAndIsClass2NicWithNoIsPayeSelfAssessment){
        @p(id = Some("nic2TaxYear")){
            @messages("chargeSummary.nic2TaxYear", viewModel.taxYearFrom.toString, viewModel.taxYearTo.toString)
        }
    }

    @if(!viewModel.chargeItem.subTransactionType.contains(Accepted)) {
        @chargeSummaryNotCodingOutAndNotPayeSelfAssessment(
            viewModel.chargeItem,
            viewModel.latePaymentInterestCharge,
            viewModel.taxYearFromCodingOut,
            viewModel.taxYearToCodingOut,
            appConfig)
    }

    @if(viewModel.chargeItem.subTransactionType.contains(Accepted)) {
        @chargeSummaryCodingOut(
            viewModel.chargeItem,
            viewModel.taxYearFromCodingOut,
            viewModel.taxYearToCodingOut,
            viewModel.latePaymentInterestCharge
        )
    }

    @if(viewModel.hasPaymentBreakdown && !viewModel.isBalancingChargeZero) {
        @chargeSummaryHasPaymentBreakdown(
            viewModel.chargeItem,
            viewModel.paymentBreakdown,
            viewModel.latePaymentInterestCharge,
            chargeSummaryLpiCharge,
            viewModel.isAgent
        )
    }

    @if(viewModel.poaExtraChargeLink.isDefined){
        @p(id = Some("poa-extra-charge-content")) {
            @messages("chargeSummary.extraCharge.text1")
            @link(id = Some("poa-extra-charge-link"), link = viewModel.poaExtraChargeLink.getOrElse(""), messageKey = "chargeSummary.extraCharge.linkText")
            @messages("chargeSummary.extraCharge.text2")
        }
    }

    @if(viewModel.latePaymentInterestCharge) @{ getInterestRatesLink() }

    @viewWhatYouOweText(viewModel)

    @if(viewModel.chargeHistoryEnabledOrPaymentAllocationWithNoIsBalancingChargeZeroAndIsNotCredit) {
        @govukTable(Table(
            head = Some(
                Seq(
                    HeadCell(HtmlContent(messages("chargeSummary.chargeHistory.date"))),
                    HeadCell(Text(messages("chargeSummary.chargeHistory.description"))),
                    HeadCell(Text(messages("chargeSummary.chargeHistory.amount")), format = Some("numeric"))
                )
            ),
            rows = Seq(
                if(viewModel.noInterestChargeAndNoCodingOutEnabledWithIsPayeSelfAssessment) Seq(
                    TableRow(HtmlContent(getCreationDate(viewModel.adjustmentHistory.creationEvent.adjustmentDate))),
                    TableRow(Text(messages(s"chargeSummary.chargeHistory.created.${viewModel.chargeItem.getChargeTypeKey(viewModel.reviewAndReconcileEnabled)}"))),
                    TableRow(HtmlContent(viewModel.adjustmentHistory.creationEvent.amount.toCurrency), format = Some("numeric"))
                ) else Nil,

                if(viewModel.latePaymentInterestCharge) Seq(
                    TableRow(HtmlContent(viewModel.chargeItem.interestEndDate.get.toLongDateShort.toNonBreaking)),
                    TableRow(Text(messages(s"chargeSummary.lpi.chargeHistory.created.${viewModel.chargeItem.getChargeTypeKey(viewModel.reviewAndReconcileEnabled)}"))),
                    TableRow(HtmlContent(viewModel.chargeItem.latePaymentInterestAmount.get.toCurrency), format = Some("numeric"))
                ) else Nil,

                if(viewModel.latePaymentInterestCharge) Seq(
                    TableRow(HtmlContent(viewModel.chargeItem.documentDate.toLongDateShort.toNonBreaking)),
                    TableRow(Text(messages("chargeSummary.codingOutPayHistoryAmount", viewModel.taxYearFromCodingOut, viewModel.taxYearToCodingOut))),
                    TableRow(HtmlContent(viewModel.chargeItem.originalAmount.toCurrency), format = Some("numeric"))
                ) else Nil
            )
                ++ viewModel.reviewAndReconcileCredit.toSeq.map { charge => Seq(
                    TableRow(HtmlContent(reviewAndReconcileCreditMessage(viewModel.isAgent, charge.taxYear.endYear, charge.transactionId, charge.transactionType.key)), attributes = Map("id" -> "rar-due-date")),
                    TableRow(Text(messages("chargeSummary.codingOutPayHistoryAmount", viewModel.taxYearFromCodingOut, viewModel.taxYearToCodingOut))),
                    TableRow(HtmlContent(charge.originalAmount.abs.toCurrency), attributes = Map("id" -> "rar-total-amount"), format = Some("numeric"))
                )}

                ++ viewModel.adjustmentHistory.adjustments.map { charge => Seq(
                    TableRow(HtmlContent(charge.adjustmentDate.getOrElse(viewModel.chargeItem.documentDate).toLongDateShort.toNonBreaking)),
                    TableRow(Text(messages(s"chargeSummary.chargeHistory.${charge.reasonCode}.${viewModel.chargeItem.getChargeTypeKey(viewModel.reviewAndReconcileEnabled)}"))),
                    TableRow(HtmlContent(charge.amount.toCurrency), format = Some("numeric"))
                )}

                ++ (for {
                        allocation <- viewModel.paymentAllocations
                        payment    <- allocation.allocations
                        if !viewModel.latePaymentInterestCharge
                    } yield { Seq(
                        TableRow(HtmlContent(payment.dueDate.getOrElse(throw MissingFieldException("Payment Date")).toLongDateShort.toNonBreaking)),
                        TableRow(HtmlContent(latePaymentInterestChargeMessage(viewModel, allocation, payment).toString)),
                        TableRow(HtmlContent(payment.amount.getOrElse(throw MissingFieldException("Payment Amount")).abs.toCurrency), format = Some("numeric"))
                    )}),
            caption = Some(chargeHistoryHeading(viewModel).toString),
            attributes = Map("id" -> "payment-history-table"),
            captionClasses = "govuk-table__caption--m",
            firstCellIsHeader = false
        ))
    }

    @if(viewModel.chargeItem.isPoaReconciliationCredit) {
        @chargeSummaryPaymentAllocationTable(
            viewModel.chargeItem,
            viewModel.poaChargeUrl,
            messages(viewModel.poaChargeLinkTextMessageKey)
        )
    }
}
