@*
 * Copyright 2023 HM Revenue & Customs
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *@

@import _root_.implicits.ImplicitCurrencyFormatter.CurrencyFormatter
@import _root_.implicits.ImplicitDateFormatterImpl
@import views.html.layouts.unifiedLayout
@import views.html.components._
@import uk.gov.hmrc.govukfrontend.views.html.components._
@import views.html.partials.chargeSummary._
@import enums.Poa1Charge
@import enums.Poa2Charge
@import enums.BalancingCharge
@import enums.TRMNewCharge
@import enums.TRMAmmendCharge
@import java.time.LocalDate
@import models.chargeSummary.ChargeSummaryViewModel




@this(
    mainTemplate: unifiedLayout,
    appConfig: config.FrontendAppConfig,
    implicitDateFormatter: ImplicitDateFormatterImpl,
    p: p,
    link: link,
    chargeSummaryLpiCharge: ChargeSummaryLpiCharge,
    chargeSummaryPaymentAllocation: ChargeSummaryPaymentAllocation,
    chargeSummaryHasPaymentBreakdown: ChargeSummaryHasPaymentBreakdown,
    chargeSummaryCodingOut: ChargeSummaryCodingOut,
    chargeSummaryHasDunningLocksOrLpiWithDunningLock: ChargeSummaryHasDunningLocksOrLpiWithDunningLock,
    chargeSummaryNotCodingOutAndNotPayeSelfAssessment: ChargeSummaryNotCodingOutAndNotPayeSelfAssessment,
    govukInsetText : GovukInsetText
)
@(viewModel: ChargeSummaryViewModel)(implicit request : Request[_], messages: Messages, appConfig: config.FrontendAppConfig)

@import implicitDateFormatter.{longDate, toTaxYearEndDate, toTaxYearStartDate}


@paymentOnAccountExplanation = {
    <div id="charge-explanation">
        @p(){
            @messages("chargeSummary.paymentsOnAccount")
        }
        <ul class="govuk-list govuk-list--bullet">
            <li>@messages("chargeSummary.paymentsOnAccount.bullet1")</li>
            <li><a href="https://www.gov.uk/self-employed-national-insurance-rates" class="govuk-link" rel="noreferrer noopener" target="_blank">@messages("chargeSummary.paymentsOnAccount.bullet2")</a></li>
        </ul>
        @p(){
            @messages("chargeSummary.paymentsOnAccount.p2")
        }
    </div>
}


@getLpiPoaExplanationContent = {
    <div>
        @if(viewModel.documentType == Poa1Charge && !viewModel.latePaymentInterestCharge) {
            @p(id = Some("lpi-poa1")){@messages("chargeSummary.paymentsOnAccount")}
        } else if (viewModel.documentType == Poa1Charge && viewModel.latePaymentInterestCharge) {
            @p(id = Some("lpi-poa2")){@messages("chargeSummary.lpi.paymentsOnAccount.poa1")}
        } else if(viewModel.documentType == Poa2Charge && !viewModel.latePaymentInterestCharge) {
            @p(id = Some("lpi-poa3")){@messages("chargeSummary.paymentsOnAccount")}
        } else if(viewModel.documentType == Poa2Charge && viewModel.latePaymentInterestCharge) {
            @p(id = Some("lpi-poa4")){@messages("chargeSummary.lpi.paymentsOnAccount.poa2")}
        }
        @if((viewModel.documentType == Poa1Charge | viewModel.documentType == Poa2Charge) && viewModel.latePaymentInterestCharge) {
            @p(id = Some("lpi-poa5")) {
                @messages("chargeSummary.lpi.paymentsOnAccount.textOne")
                <a class="govuk-link" href="https://www.bankofengland.co.uk/monetary-policy/the-interest-rate-bank-rate">@messages("chargeSummary.lpi.paymentsOnAccount.linkText")</a>
                @messages("chargeSummary.lpi.paymentsOnAccount.textTwo")
            }
            @p(id = Some("lpi-poa6")) {
                @messages("chargeSummary.lpi.paymentsOnAccount.p3")
                <a class="govuk-link" href="https://www.gov.uk/government/publications/rates-and-allowances-hmrc-interest-rates-for-late-and-early-payments/rates-and-allowances-hmrc-interest-rates#current-late-payment-and-repayment-interest-rates">@messages("chargeSummary.lpi.paymentsOnAccount.p3LinkText")</a><br><br>
            }
        }
    </div>
}

@balancingChargeExplanation = {
    <div id="charge-explanation">
        @p(){@messages("chargeSummary.definition.balancingcharge.p1")}
        <ul class="govuk-list govuk-list--bullet">
            <li>@messages("chargeSummary.definition.balancingcharge.bullet1")</li>
            <li>@messages("chargeSummary.definition.balancingcharge.bullet2")</li>
        </ul>
        @p(){@messages("chargeSummary.definition.balancingcharge.p2")}
    </div>
}

@hmrcAdjustmentExplanation = {
    <div id="charge-explanation">
        @p(){@messages("chargeSummary.definition.hmrcadjustment")}
    </div>
}

@getBalancingPaymentsExplanationContent = {
    <div>
        @p(id = Some("lpi-bcd1")){@messages("chargeSummary.lpi.balancingCharge.p1")}
        @p(id = Some("lpi-bcd2")) {
            @messages("chargeSummary.lpi.balancingCharge.textOne")
            <a class="govuk-link" href="https://www.bankofengland.co.uk/monetary-policy/the-interest-rate-bank-rate">@messages("chargeSummary.lpi.balancingCharge.linkText")</a>
            @messages("chargeSummary.lpi.balancingCharge.textTwo")
        }
        @p(id = Some("lpi-bcd3")) {
            @messages("chargeSummary.lpi.balancingCharge.p3")
            <a class="govuk-link" href="https://www.gov.uk/government/publications/rates-and-allowances-hmrc-interest-rates-for-late-and-early-payments/rates-and-allowances-hmrc-interest-rates#current-late-payment-and-repayment-interest-rates">@messages("chargeSummary.lpi.balancingCharge.p3LinkText")</a><br><br>
        }
    </div>
}

@getExplanationContent = @{viewModel.documentType match {
        case _ if viewModel.isMFADebit  => hmrcAdjustmentExplanation
        case Poa1Charge | Poa2Charge if !viewModel.latePaymentInterestCharge => paymentOnAccountExplanation
        case Poa1Charge | Poa2Charge if viewModel.latePaymentInterestCharge => getLpiPoaExplanationContent
        case TRMNewCharge if !viewModel.latePaymentInterestCharge => balancingChargeExplanation //TRMNewCharge used instead of Balancing charge
        case BalancingCharge if viewModel.latePaymentInterestCharge => getBalancingPaymentsExplanationContent
        case TRMNewCharge if viewModel.latePaymentInterestCharge => getBalancingPaymentsExplanationContent //LPI Balancing charge uses TRMCharge on one page and Balancing Charge on another page
        case _                          =>
    }
}



@checkPayeCodePara = {
    @p(id = Some("check-paye-para")){
        @messages("chargeSummary.check-paye-tax-code-1")
        <a class="govuk-link" id="paye-tax-code-link" href="https://www.tax.service.gov.uk/check-income-tax/tax-codes/@viewModel.currentTaxYearEnd">
            @messages("chargeSummary.check-paye-tax-code-2")</a>
        @messages("chargeSummary.check-paye-tax-code-3", viewModel.taxYearFrom.toString, viewModel.taxYearTo.toString)
    }
}


@paymentProcessingInfo = {
    @p(id = Some("payment-days-note")){
        @if(viewModel.isAgent) {
            @messages("chargeSummary.payment-days-note-agent")
        } else {
            @messages("chargeSummary.payment-days-note")
        }
    }

    <ul class="govuk-list govuk-list--bullet" id="payment-processing-bullets">
        @if(viewModel.isAgent) {
            <li>@messages("chargeSummary.payments-bullet1-1")
                @link(link = "https://www.gov.uk/pay-self-assessment-tax-bill", messageKey = "chargeSummary.payments-bullet1-2-agent", target = Some("_blank"), rel=Some("noreferrer noopener"))
            </li>
            <li>@messages("chargeSummary.payments-bullet2-agent")</li>
        } else {
            <li>@messages("chargeSummary.payments-bullet1-1")
                @link(link = "https://www.gov.uk/pay-self-assessment-tax-bill", messageKey = "chargeSummary.payments-bullet1-2", target = Some("_blank"), rel=Some("noreferrer noopener"))
            </li>
            <li>@messages("chargeSummary.payments-bullet2")</li>
        }
    </ul>
}

@codingOutMessage = {
    @p(id=Some("coding-out-message")){
        @messages("chargeSummary.codingOutMessage", viewModel.taxYearFrom.toString, viewModel.taxYearTo.toString)
    }
}

@codingOutMessageInset = {
    @p(id = Some("coding-out-notice")) {
        @messages("chargeSummary.codingOutInset-1")
        @link(
            id = Some("coding-out-notice-link"),
            link="https://www.gov.uk/pay-self-assessment-tax-bill/through-your-tax-code",
            target = Some("_blank"),
            rel= Some("noreferrer noopener"),
            messageKey = "chargeSummary.codingOutInset-2"
        )
        @messages("chargeSummary.codingOutInset-3")
    }
}

@codingOutCancelledMessageInset = {
    @p(id = Some("cancelled-coding-out-notice")) {
        @messages("chargeSummary.cancelledPayeInset-1")
        @link(
            id = Some("cancelled-coding-out-notice-link"),
            link="https://www.gov.uk/pay-self-assessment-tax-bill/through-your-tax-code",
            target = Some("_blank"),
            rel= Some("noreferrer noopener"),
            messageKey = "chargeSummary.cancelledPayeInset-2",
            additionalOpenTabMessage = Some(".")
        )
        @messages("chargeSummary.cancelledPayeInset-3")
    }
}

@chargeHistoryHeading = @{
    val text = viewModel.documentType match {
        case _ if viewModel.latePaymentInterestCharge => messages("chargeSummary.chargeHistory.lateInterestPayment")
        case Poa1Charge => messages("chargeSummary.chargeHistory.Poa1heading")
        case Poa2Charge => messages("chargeSummary.chargeHistory.Poa2heading")
        case _ => messages("chargeSummary.chargeHistory.heading")
    }
    viewModel.documentDetail.transactionId + text
}

@getCreationDate(date: Option[LocalDate]) = @{
    date match {
        case Some(value) => value.toLongDateShort
        case None => messages("incomeSources.generic.unknown")
    }
}

@mainTemplate(pageTitle = messages(viewModel.pageTitle), backUrl = Some(viewModel.backUrl), isAgent = viewModel.isAgent, btaNavPartial = viewModel.btaNavPartial,
    useFallbackBackLink = true, gatewayPage = viewModel.gatewayPage) {

    @if(viewModel.hasDunningLocks || viewModel.documentDetail.hasLpiWithDunningLock) {
        @chargeSummaryHasDunningLocksOrLpiWithDunningLock(viewModel.documentDetail, viewModel.dueDate, viewModel.latePaymentInterestCharge, appConfig)
    }

    <h1 class="govuk-heading-xl">
        @{
            val taxYearStartDate = toTaxYearStartDate(viewModel.taxYearFrom).toLongDate
            val taxYearEndDate = toTaxYearEndDate(viewModel.taxYearTo).toLongDate
            <span class="govuk-caption-xl">{messages("paymentDue.tax-year", taxYearStartDate, taxYearEndDate)}</span>
        }
        @{
            messages(viewModel.pageTitle)
        }
    </h1>

@getExplanationContent

    @if(viewModel.codingOutEnabled && viewModel.documentDetail.isPayeSelfAssessment){
        @checkPayeCodePara
        <div id="coding-out-wrapper">
            @govukInsetText(InsetText(content = HtmlContent(codingOutMessageInset)))
        </div>
        @codingOutMessage
    }

    @if(viewModel.codingOutEnabled && viewModel.documentDetail.isCancelledPayeSelfAssessment){
        @checkPayeCodePara
        <div id="cancelled-coding-out-wrapper">
            @govukInsetText(InsetText(content = HtmlContent(codingOutCancelledMessageInset)))
        </div>
        @codingOutMessage
    }

    @if(viewModel.codingOutEnabledAndIsClass2NicWithNoIsPayeSelfAssessment){
        @p(id = Some("nic2TaxYear")){
            @messages("chargeSummary.nic2TaxYear", viewModel.taxYearFrom.toString, viewModel.taxYearTo.toString)
        }
    }

    <dl class="govuk-summary-list">
        @if(!(viewModel.codingOutEnabled && viewModel.documentDetail.isPayeSelfAssessment)) {
            @chargeSummaryNotCodingOutAndNotPayeSelfAssessment(
                viewModel.documentDetailWithDueDate,
                viewModel.documentDetail,
                viewModel.latePaymentInterestCharge,
                viewModel.codingOutEnabled,
                viewModel.taxYearFromCodingOut,
                viewModel.taxYearToCodingOut,
                appConfig)
        }
    </dl>

    @if(viewModel.codingOutEnabled && viewModel.documentDetail.isPayeSelfAssessment) {
        @chargeSummaryCodingOut(
            viewModel.documentDetail,
            viewModel.codingOutEnabled,
            viewModel.taxYearFromCodingOut,
            viewModel.taxYearToCodingOut,
            viewModel.latePaymentInterestCharge
        )
    }

    @if(viewModel.hasPaymentBreakdown && !viewModel.isBalancingChargeZero) {
        @chargeSummaryHasPaymentBreakdown(
            viewModel.documentDetailWithDueDate,
            viewModel.paymentBreakdown,
            viewModel.latePaymentInterestCharge,
            viewModel.documentDetail,
            chargeSummaryLpiCharge,
            viewModel.isAgent
        )
    }

    @if(viewModel.hasInterestLocks && viewModel.hasAccruedInterest) {
        @p(id=Some("p-interest-locks-msg")){
            @if(viewModel.isAgent) {
                @messages("chargeSummary.whatYouOwe.textOne-agent")
                @link(id = Some("what-you-owe-interest-link-agent"), link = viewModel.whatYouOweUrl, messageKey = "chargeSummary.whatYouOwe.linkText-agent")
                @messages("chargeSummary.interestLocks.text-agent")
            } else {
                @messages("chargeSummary.whatYouOwe.textOne")
                @link(id = Some("what-you-owe-interest-link"), link = viewModel.whatYouOweUrl, messageKey = "chargeSummary.whatYouOwe.linkText")
                @messages("chargeSummary.interestLocks.text")
            }

        }
    } else {
        @p(){
            @if(viewModel.isAgent) {
                @messages("chargeSummary.whatYouOwe.textOne-agent"),
                @link(id = Some("what-you-owe-link-agent"), link = viewModel.whatYouOweUrl, messageKey = "chargeSummary.whatYouOwe.linkText-agent")
                @messages("chargeSummary.whatYouOwe.textTwo-agent")
            } else {
                @messages("chargeSummary.whatYouOwe.textOne")
                @link(id = Some("what-you-owe-link"), link = viewModel.whatYouOweUrl, messageKey = "chargeSummary.whatYouOwe.linkText")
                @messages("chargeSummary.whatYouOwe.textTwo")
            }
        }
    }

    @if(viewModel.noIsAgentAndRemainingToPayWithNoCodingOutEnabledAndIsPayeSelfAssessment){
        <div id="payment-link-@{viewModel.taxYearTo}">
            <a class="govuk-button" role="button" data-module="govuk-button" href="@controllers.routes.PaymentController.paymentHandoff(viewModel.documentDetail.remainingToPay.toPence, viewModel.origin)">
                @messages("paymentDue.payNow")
                <span class="govuk-visually-hidden">@messages("paymentDue.pay-now-hidden", viewModel.taxYearFrom.toString, viewModel.taxYearTo.toString)</span>
            </a>
        </div>
        @paymentProcessingInfo
    }

    @if(viewModel.isAgentAndRemainingToPayWithNoCodingOutEnabledAndIsPayeSelfAssessment){
        @paymentProcessingInfo
    }

    @if(viewModel.chargeHistoryEnabledOrPaymentAllocationWithNoIsBalancingChargeZero){
        @if(viewModel.hasPaymentBreakdown && viewModel.documentDetail.isNotCodingOutDocumentDetail) {
            <h3 class="govuk-heading-l">@chargeHistoryHeading</h3>
        } else {
            <h2 class="govuk-heading-l">@chargeHistoryHeading</h2>
        }

        <table class="govuk-table" id="payment-history-table">

            <thead class="govuk-table__head">
            <tr class="govuk-table__row">
                <th scope="col" class="govuk-table__header">@messages("chargeSummary.chargeHistory.date")</th>
                <th scope="col" class="govuk-table__header">@messages("chargeSummary.chargeHistory.description")</th>
                <th scope="col" class="govuk-table__header govuk-!-text-align-right">@messages("chargeSummary.chargeHistory.amount")</th>
            </tr>
            </thead>

            <tbody class = "govuk-table__body">
            @if(viewModel.chargeHistoryEnabled){
                @if(viewModel.noLatePaymentInterestChargeAndNoCodingOutEnabledWithIsPayeSelfAssessment) {
                    <tr>
                        <td class="govuk-table__cell govuk-!-width-one-quarter">@{
                            getCreationDate(viewModel.adjustmentHistory.creationEvent.adjustmentDate)
                        }</td>
                        <td class="govuk-table__cell">@{
                            if (viewModel.isMFADebit) messages(s"chargeSummary.chargeHistory.created.hmrcAdjustment.text") else
                                messages(s"chargeSummary.chargeHistory.created.${viewModel.documentDetail.getChargeTypeKey(viewModel.codingOutEnabled)}")
                        }
                        </td>
                        <td class="govuk-table__cell numeric govuk-!-text-align-right">@{
                            viewModel.adjustmentHistory.creationEvent.amount.toCurrency
                        }</td>
                    </tr>
                }

                @if(viewModel.latePaymentInterestCharge) {
                    <tr>
                        <td class="govuk-table__cell govuk-!-width-one-quarter">@{viewModel.documentDetail.interestEndDate.get.toLongDateShort}</td>
                        <td class="govuk-table__cell">@messages(s"chargeSummary.lpi.chargeHistory.created.${viewModel.documentDetail.getChargeTypeKey()}")</td>
                        <td class="govuk-table__cell govuk-!-text-align-right">@{viewModel.documentDetail.latePaymentInterestAmount.get.toCurrency}</td>
                    </tr>
                }

                @if(viewModel.codingOutEnabled && viewModel.documentDetail.isPayeSelfAssessment) {
                    <tr>
                        <td class="govuk-table__cell govuk-!-width-one-quarter">@{viewModel.documentDetail.documentDate.toLongDateShort}</td>
                        <td class="govuk-table__cell">@messages("chargeSummary.codingOutPayHistoryAmount", viewModel.taxYearFromCodingOut, viewModel.taxYearToCodingOut)</td>
                        <td class="govuk-table__cell">@{viewModel.documentDetail.originalAmount.toCurrency}</td>
                    </tr>
                }

                @for(charge <- viewModel.adjustmentHistory.adjustments) {
                    <tr>
                        <td class="govuk-table__cell govuk-!-width-one-quarter">@{charge.adjustmentDate.getOrElse(viewModel.documentDetail.documentDate).toLongDateShort}</td>
                        <td class="govuk-table__cell">@messages(s"chargeSummary.chargeHistory.${charge.reasonCode}.${viewModel.documentDetail.getChargeTypeKey()}")</td>
                        <td class="govuk-table__cell">@{charge.amount.toCurrency}</td>
                    </tr>
                }
            }

            @if(viewModel.paymentAllocationEnabled && !viewModel.latePaymentInterestCharge) {
                @chargeSummaryPaymentAllocation(viewModel.paymentAllocations, viewModel.payments, viewModel.documentDetailWithDueDate, viewModel.isAgent, viewModel.isMFADebit, None, viewModel.taxYearFromCodingOut, viewModel.taxYearToCodingOut)
            }
            </tbody>
        </table>
    }
}
