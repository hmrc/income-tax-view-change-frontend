@*
 * Copyright 2023 HM Revenue & Customs
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *@

@import _root_.implicits.ImplicitDateFormatterImpl
@import _root_.implicits.ImplicitCurrencyFormatter._
@import models.financialDetails.WhatYouOweChargesList
@import auth.MtdItUser
@import views.html.layouts.unifiedLayout
@import views.html.components._
@import uk.gov.hmrc.govukfrontend.views.html.components._
@import java.time.LocalDate
@import models.nextPayments.viewmodels.WYOClaimToAdjustViewModel
@import services.DateServiceInterface
@import uk.gov.hmrc.govukfrontend.views.viewmodels.warningtext.WarningText
@import _root_.implicits.HtmlFormatter.NbspString
@import views.html.partials.whatYouOwe._
@import views.helpers.whatYouOweChargesSummary.WYOMessagesHelper.getMessage
@import views.helpers.whatYouOweChargesSummary.WYOMessagesHelper.getNoPaymentsDueText
@import views.helpers.whatYouOweChargesSummary.WYOMessagesHelper.getHeading
@import controllers.routes._

@this(
    mainTemplate: unifiedLayout,
    implicitDateFormatter: ImplicitDateFormatterImpl,
    h1: h1,
    h2: h2,
    p: p,
    govukWarningText: GovukWarningText,
    govukButton: GovukButton,
    govukTable: GovukTable,
    balancingChargePreMtdDigital: BalancingChargePreMtdDigital,
    interestOnBalancingCharge: InterestOnBalancingCharge,
    chargeInfo: ChargeInfo,
    accruingInterestCharge: AccruingInterestCharge,
    saNoteParagraph: SaNoteParagraph,
    dunningLockParagraph: DunningLockParagraph,
    claimToAdjustPoaSection: ClaimToAdjustPoaSection,
    codingOutInsetContent: CodingOutInsetContent,
    paymentTypeEntry: PaymentTypeEntry,
    paymentsMadeContent: PaymentsMadeContent,
    interestMessage: InterestMessage,
    taxYearSummaryLink: TaxYearSummaryLink,
    availableCreditInAccount: AvailableCreditInAccount,
    unallocatedCreditParagraphContent: UnallocatedCreditParagraphContent
)
@(
    currentDate: LocalDate,
    hasOverdueOrAccruingInterestCharges: Boolean,
    whatYouOweChargesList: WhatYouOweChargesList,
    hasLpiWithDunningLock: Boolean,
    currentTaxYear: Int,
    backUrl: String,
    utr: Option[String],
    dunningLock: Boolean,
    reviewAndReconcileEnabled: Boolean,
    isAgent: Boolean = false,
    creditAndRefundUrl: String,
    creditAndRefundEnabled: Boolean,
    returnHref: Int => String,
    claimToAdjustViewModel: WYOClaimToAdjustViewModel,
    LPP2Url: String,
    adjustPoaUrl: String,
    origin: Option[String] = None
)(
    implicit request: Request[_],
    user: MtdItUser[_],
    messages: Messages,
    dateService: DateServiceInterface
)

@import implicitDateFormatter.longDate

@mainTemplate(
    pageTitle = getHeading,
    backUrl = Some(backUrl),
    isAgent = isAgent,
    btaNavPartial = user.btaNavPartial
) {
    @h1(msg = getHeading, id = Some("page-heading"))

    @if(whatYouOweChargesList.isChargesListEmpty && whatYouOweChargesList.codedOutDetails.isEmpty) {

        @p(id = Some("no-payments-due"))(Html(getNoPaymentsDueText))

        @claimToAdjustPoaSection(
            whatYouOweChargesList.hasUnpaidPOAs,
            claimToAdjustViewModel.claimToAdjustTaxYear,
            adjustPoaUrl
        )

        @saNoteParagraph(utr)

    } else {

        @if(hasOverdueOrAccruingInterestCharges) {

            @govukWarningText(WarningText(
                attributes = Map("id" -> "interest-charges-warning"),
                content = Text(getMessage("interestChargesWarning"))
            ))
        }

        @if(whatYouOweChargesList.chargesList.nonEmpty || whatYouOweChargesList.bcdChargeTypeDefinedAndGreaterThanZero) {

            @govukTable(Table(
                head = Some(Seq(
                    HeadCell(
                        content = Text(getMessage("tableHead.due-date"))
                    ),
                    HeadCell(
                        content = Text(getMessage("tableHead.charge-type"))
                    ),
                    HeadCell(
                        content = Text(getMessage("tableHead.tax-year"))
                    ),
                    HeadCell(
                        content = HtmlContent(getMessage("tableHead.amount-due").toNbsp)
                    )
                )),
                rows = Seq(
                    Option.when(whatYouOweChargesList.bcdChargeTypeDefinedAndGreaterThanZero)(
                        Seq(
                            TableRow(
                                attributes = Map("id" -> "balancing-charge-due-date-0"),
                                content = Text(whatYouOweChargesList.getRelevantDueDate.toLongDateShort)
                            ),
                            TableRow(
                                attributes = Map("id" -> "balancing-charge-type-0"),
                                content = HtmlContent(balancingChargePreMtdDigital(whatYouOweChargesList, currentDate))
                            ),
                            TableRow(
                                attributes = Map("id" -> "balancing-charge-tax-year-0"),
                                content = Text(getMessage("pre-mtd-year", (currentTaxYear - 2).toString, (currentTaxYear - 1).toString))
                            ),
                            TableRow(
                                attributes = Map("id" -> "balancing-charge-amount-due-0"),
                                content = HtmlContent(whatYouOweChargesList.outstandingChargesModel.get.bcdChargeType.get.chargeAmount.toCurrency),
                                format = Some("numeric")
                            ),
                        )
                    ),
                    Option.when(
                        whatYouOweChargesList.bcdChargeTypeDefinedAndGreaterThanZero &&
                        whatYouOweChargesList.outstandingChargesModel.get.getAciChargeWithTieBreaker.isDefined &&
                        whatYouOweChargesList.getRelevantDueDate.isBefore(currentDate)
                    )(
                        Seq(
                            TableRow(
                                content = Empty
                            ),
                            TableRow(
                                attributes = Map("id" -> "balancing-charge-due-date-1"),
                                content = HtmlContent(interestOnBalancingCharge(whatYouOweChargesList, currentDate))
                            ),
                            TableRow(
                                attributes = Map("id" -> "balancing-charge-type-1"),
                                content = HtmlContent(getMessage("pre-mtd-year", (currentTaxYear - 2).toString, (currentTaxYear - 1).toString))
                            ),
                            TableRow(
                                attributes = Map("id" -> "balancing-charge-amount-due-1"),
                                content = HtmlContent(whatYouOweChargesList.getAciChargeWithTieBreakerChargeAmount.toCurrency),
                                format = Some("numeric")
                            ),
                        )
                    ) ++ (for ((charge, index) <- whatYouOweChargesList.sortedChargesList.zipWithIndex) yield {
                        Seq(
                            Seq(
                                TableRow(
                                    attributes = Map("id" -> s"due-charge-due-date-$index"),
                                    content = HtmlContent(charge.getChargeDueDate.toLongDateShort.toNbsp)
                                ),
                                TableRow(
                                    attributes = Map("id" -> s"due-charge-$index"),
                                    content = HtmlContent(chargeInfo(LPP2Url, s"due-$index", charge, index, origin))
                                ),
                                TableRow(
                                    attributes = Map("id" -> s"due-charge-tax-year-$index"),
                                    content = HtmlContent(taxYearSummaryLink(charge.taxYear.endYear, index, returnHref))
                                ),
                                TableRow(
                                    attributes = Map("id" -> s"due-charge-amount-due-$index"),
                                    content = HtmlContent(charge.remainingToPayOnCharge.toCurrency),
                                    format = Some("numeric")
                                )
                            )
                        ) ++ Option.when(charge.hasAccruingInterest)(
                            Seq(
                                TableRow(
                                    content = Empty
                                ),
                                TableRow(
                                    attributes = Map("id" -> s"accrued-interest-charge-type-$index"),
                                    content = HtmlContent(accruingInterestCharge(charge))
                                ),
                                TableRow(
                                    attributes = Map("id" -> s"accrued-interest-tax-year-$index"),
                                    content = HtmlContent(taxYearSummaryLink(charge.taxYear.endYear, index, returnHref))
                                ),
                                TableRow(
                                    attributes = Map("id" -> s"accrued-interest-amount-due-$index"),
                                    content = HtmlContent(charge.getInterestOutstandingAmount.toCurrency),
                                    format = Some("numeric")
                                )
                            ))
                    }).flatten
                ).flatten,
                caption = Some(getMessage("payments-due")),
                attributes = Map("id" -> "payments-due-table"),
                captionClasses = "govuk-table__caption govuk-visually-hidden"
            ))
        }

        @if(!whatYouOweChargesList.isChargesListEmpty && (dunningLock || hasLpiWithDunningLock) ) {
            @dunningLockParagraph()
        }

        @claimToAdjustPoaSection(
            whatYouOweChargesList.hasUnpaidPOAs,
            claimToAdjustViewModel.claimToAdjustTaxYear,
            adjustPoaUrl
        )

        @whatYouOweChargesList.codedOutDetails.map { codedOutDetails =>
            @codingOutInsetContent(codedOutDetails, origin)
        }

        @saNoteParagraph(utr)

        @whatYouOweChargesList.availableCredit.map { availableCreditAmt =>
            @unallocatedCreditParagraphContent(creditAndRefundUrl, availableCreditAmt.toCurrencyString)
        }

        @if(utr.isDefined && !isAgent && whatYouOweChargesList.getEarliestTaxYearAndAmountByDueDate.isDefined) {

            @govukButton(Button(
                id = Some("payment-button-link"),
                content = Text(getMessage("payNow")),
                href = Some(PaymentController.paymentHandoff(whatYouOweChargesList.getEarliestTaxYearAndAmountByDueDate.get._2.toPence, origin).url)
            ))
        }

        @paymentsMadeContent()
    }

    @if(creditAndRefundEnabled){
        @whatYouOweChargesList.availableCredit.map { ac =>
            @availableCreditInAccount(ac.toCurrencyString, creditAndRefundUrl)
        }
    }
}
