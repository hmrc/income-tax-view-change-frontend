@*
 * Copyright 2023 HM Revenue & Customs
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *@

@import _root_.implicits.ImplicitDateFormatterImpl
@import views.html.layouts.unifiedLayout
@import views.html.components._
@import uk.gov.hmrc.govukfrontend.views.html.components._
@import uk.gov.hmrc.govukfrontend.views.html.components.FormWithCSRF
@import uk.gov.hmrc.hmrcfrontend.views.html.components.HmrcPageHeading
@import uk.gov.hmrc.hmrcfrontend.views.viewmodels.pageheading.PageHeading
@import models.core.AddressModel
@import models.incomeSourceDetails.viewmodels.ManageIncomeSourceDetailsViewModel
@import enums.IncomeSourceJourney.{SelfEmployment, ForeignProperty, UkProperty}

@this(
        mainTemplate: unifiedLayout,
        hmrcPageHeading: HmrcPageHeading,
        govukSummaryList: GovukSummaryList,
        implicitDateFormatter: ImplicitDateFormatterImpl,
        h1: h1,
        h2: h2,
        p: p,
        link: link,
        hr: hr,
        govukTable: GovukTable,
        govukButton: GovukButton,
        formWithCSRF: FormWithCSRF
)

@(
        viewModel: ManageIncomeSourceDetailsViewModel,
        isAgent: Boolean,
        backUrl: String
)(implicit messages: Messages, user: auth.MtdItUser[_])

@import play.twirl.api.HtmlFormat
@import implicitDateFormatter.longDate

@getMessage(key: String, args: String*) = @{
    messages(s"incomeSources.manage.business-manage-details.$key", args: _*)
}

@changeReportingMethodUrl(taxYear: String, changeTo: String) = @{
    viewModel.incomeSourceType match {
        case SelfEmployment =>
            controllers.incomeSources.manage.routes.ConfirmReportingMethodSharedController.show(taxYear, changeTo, isAgent, SelfEmployment).url
        case UkProperty =>
            controllers.incomeSources.manage.routes.ConfirmReportingMethodSharedController.show(taxYear, changeTo, isAgent, UkProperty).url
        case ForeignProperty =>
            controllers.incomeSources.manage.routes.ConfirmReportingMethodSharedController.show(taxYear, changeTo, isAgent, ForeignProperty).url
    }
}

@changeToValue(currentMethod: String) = @{
    if(currentMethod == "Q") {
        "annual"
    } else {
        "quarterly"
    }
}

@taxYearValue(taxYear: String) = @{
    s"${taxYear}-${(taxYear.toInt + 1).toString}"
}

@extractOption(content: Option[String]) = @{
    content match {
        case Some(x) => x
        case None => messages("incomeSources.generic.unknown")
    }
}

@getAccountingMethodMessage = @{
    viewModel.incomeSourceType match {
        case SelfEmployment => messages("incomeSources.manage.business-manage-details.accounting-method")
        case UkProperty => messages("incomeSources.manage.uk-property-manage-details.accounting-method")
        case ForeignProperty => messages("incomeSources.manage.foreign-property-manage-details.accounting-method")
    }
}

@getSectionMessage = @{
    viewModel.incomeSourceType match {
        case SelfEmployment => messages("incomeSources.manage.business-manage-details.sole-trader-section")
        case UkProperty => messages("incomeSources.manage.uk-property-manage-details.uk-property-section")
        case ForeignProperty => messages("incomeSources.manage.foreign-property-manage-details.foreign-property-section")
    }
}

@getSEList = @{
    Seq(
        SummaryListRow(
            key = Key(
                content = Text(getMessage("business-name"))
            ),
            value = Value(
                content = Text(extractOption(viewModel.tradingName))
            ),
            actions = Some(Actions(
                items = Seq(
                    ActionItem(
                        attributes = Map("id" -> "business-name")
                    )
                )
            ))
        ),
        SummaryListRow(
            key = Key(
                content = Text(getMessage("business-address"))
            ),
            value = Value(
                content = (
                        getLongAddressFromBusinessAddressDetails(viewModel.address) match {
                            case Some(x) => HtmlContent(s"""$x""")
                            case None => Text(messages("incomeSources.generic.unknown"))
                        }
                        )
            )
        )
    )
}

@getLongAddressFromBusinessAddressDetails(address: Option[AddressModel]) = @{
    address match {
        case Some(address) =>
            val nonNoneFields = List(
                Some(address.addressLine1),
                address.addressLine2,
                address.addressLine3,
                address.addressLine4,
                address.postCode,
                Some(address.countryName)
            ).flatten
            Some(nonNoneFields.mkString("<br>"))
        case None => None
    }
}

@getTaxYears = @{
    Seq(
        SummaryListRow(
            key = Key(
                content = Text(getMessage("reporting-method", viewModel.latencyDetails.get.taxYear1, viewModel.latencyDetails.get.taxYear2))
            ),
            value = Value(
                content = Text(getMessage(viewModel.latencyValueAsKey(viewModel.latencyDetails.get.latencyIndicator1)))
            ),
            actions = if(!viewModel.taxYearOneCrystallised.get) Some(Actions(
                items = Seq(
                    ActionItem(
                        href = changeReportingMethodUrl(taxYearValue(viewModel.latencyDetails.get.taxYear1), changeToValue(viewModel.latencyDetails.get.latencyIndicator1)),
                        content = Text(getMessage("change")),
                        attributes = Map("id" -> "change-link-1")
                    )
                )
            ))
            else None
        ),
        SummaryListRow(
            key = Key(
                content = Text(getMessage("reporting-method", viewModel.latencyDetails.get.taxYear2, (viewModel.latencyDetails.get.taxYear2.toInt + 1).toString))
            ),
            value = Value(
                content = HtmlContent(getMessage(viewModel.latencyValueAsKey(viewModel.latencyDetails.get.latencyIndicator2)))
            ),
            actions = if(!viewModel.taxYearTwoCrystallised.get) Some(Actions(
                items = Seq(
                    ActionItem(
                        href = changeReportingMethodUrl(taxYearValue(viewModel.latencyDetails.get.taxYear2), changeToValue(viewModel.latencyDetails.get.latencyIndicator2)),
                        content = Text(getMessage("change")),
                        attributes = Map("id" -> "change-link-2")
                    )
                )
            )) else None
        )
    )
}

@mainTemplate(
    pageTitle = getMessage("heading"),
    backUrl = Some(backUrl),
    isAgent = isAgent,
    btaNavPartial = user.btaNavPartial) {

    @hmrcPageHeading(PageHeading(
        text = getMessage("heading"),
        headingClasses = Some("govuk-heading-l"),
        section = Some(getSectionMessage),
        captionClasses = Some("govuk-caption-l")
    ))

    @govukSummaryList(SummaryList(
        rows = {
            if(viewModel.incomeSourceType == SelfEmployment) getSEList else Seq.empty
        } ++ Seq(
            SummaryListRow(
                key = Key(
                    content = Text(getMessage("date-started"))
                ),
                value = Value(
                    content = Text(
                        viewModel.tradingStartDate match {
                            case Some(x) => x.toLongDate
                            case None => messages("incomeSources.generic.unknown")
                        }
                    )
                )
            ),
            SummaryListRow(
                key = Key(
                    content = Text(getAccountingMethodMessage)
                ),
                value = Value(
                    content = Text(messages(viewModel.businessAccountingMethodAsKey(viewModel.businessAccountingMethod)))
                )
            ))
                ++ {
            if(viewModel.itsaHasMandatedOrVoluntaryStatusCurrentYear
                    && viewModel.latencyDetails.isDefined) getTaxYears else Seq.empty
        },
        attributes = Map("id" -> "manage-details-table")),
    )
    <br>
    <br>

}

